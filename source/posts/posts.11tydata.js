const Image = require("@11ty/eleventy-img");

// Filters are not available in .11tydata.js.
const { blogPermalink } = require("../../lib/filters/permalink");

// Provide common fields for all the posts.
module.exports = {
  layout: "layouts/post",
  eleventyComputed: {
    async image({ image, page }) {
      // Use the `image` from front matter if possible.
      if (image) {
        // Optimize JPEG
        // TODO: Support other formats.
        if (image.startsWith("/images/") && image.endsWith(".jpg")) {
          try {
            const stats = await Image("source" + image, {
              formats: ["jpeg"],
              widths: [800],
              // TODO: Share these with imageopt.
              urlPath: "/cached/",
              outputDir: "./public/cached/"
            });
            if (stats.jpeg[0]) {
              return stats.jpeg[0].url;
            }
          } catch (err) {
            console.error(
              "[posts.11tydata.js] Failed to optimize OG image",
              image,
              err
            );
          }
        }
      }
      // Otherwise, use the one generated by `blog/title-image.11ty.js`.
      return `/${blogPermalink(page, "title.png")}`;
    }
  }
};
