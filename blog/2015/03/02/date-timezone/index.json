{"site":{"title":"Shuhei Kagawa","author":"Shuhei Kagawa","perPage":3,"newPageExtension":"markdown","blogDir":"blog","sourceDir":"source","layoutDir":"_layouts","postDir":"_posts"},"post":{"layout":"post","title":"Assign Time/time string in UTC to ActiveRecord date attribute","date":"2015-03-02 20:58","comments":true,"categories":["Ruby","Rails"],"url":"/blog/2015/03/02/date-timezone/","content":"<p><strong>TL;DR: <code>gem &#39;date_timezone&#39;</code> in <code>Gemfile</code> and <code>include DateTimezone</code> in ActiveRecord models if you are on the east side of the prime meridian.</strong></p>\n<p>ActiveRecord is great. It automatically converts data <a href=\"https://github.com/rails/rails/tree/v4.2.0/activerecord/lib/active_record/type\">according to the type of database column</a>. That&#39;s why we can throw request params, whose values are often strings, into mass assignment methods like <code>create</code> and <code>update</code> without manual conversion. The conversion works perfectly in most of the cases except for <code>date</code> attribute.</p>\n<p>To <code>date</code> attribute, we can assign <code>Date</code> and date string like <code>&#39;2015-03-02&#39;</code> without any problem. However, <code>Time</code> and time string with different time zone, usualy UTC, don&#39;t work well here. Their own time zones are not taken into account when converted to <code>Date</code>.</p>\n<pre><code class=\"hljs ruby\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Application</span> <span class=\"hljs-inheritance\">&lt; <span class=\"hljs-parent\">Rails::Application</span></span></span>\n  config.time_zone = <span class=\"hljs-string\">'Tokyo'</span>\n<span class=\"hljs-keyword\">end</span>\n\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Person</span> <span class=\"hljs-inheritance\">&lt; <span class=\"hljs-parent\">ActiveRecord::Base</span></span></span>\n  <span class=\"hljs-comment\"># birth_date :date</span>\n<span class=\"hljs-keyword\">end</span>\n\nexpect(<span class=\"hljs-constant\">Person</span>.new(<span class=\"hljs-symbol\">birth_date:</span> <span class=\"hljs-string\">'2015-03-02'</span>).birth_date).to eq(<span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>))\nexpect(<span class=\"hljs-constant\">Person</span>.new(<span class=\"hljs-symbol\">birth_date:</span> <span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>)).birth_date).to eq(<span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>))\nexpect(<span class=\"hljs-constant\">Person</span>.new(<span class=\"hljs-symbol\">birth_date:</span> <span class=\"hljs-constant\">Time</span>.zone.local(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>)).birth_date).to eq(<span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>))\n\n<span class=\"hljs-comment\"># But...</span>\nexpect(<span class=\"hljs-constant\">Person</span>.new(<span class=\"hljs-symbol\">birth_date:</span> <span class=\"hljs-constant\">Time</span>.utc(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">15</span>)).birth_date).to eq(<span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">1</span>))\nexpect(<span class=\"hljs-constant\">Person</span>.new(<span class=\"hljs-symbol\">birth_date:</span> <span class=\"hljs-string\">'2015-03-01T15:00:00.000Z'</span>).birth_date).to eq(<span class=\"hljs-constant\">Date</span>.new(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">1</span>))</code></pre><p>There may be several cases that we have to assign <code>Time</code> or time string in different time zone to <code>date</code> attribute. My own case was a Single Page Application built with AngularJS that sends JavaScript&#39;s <code>Date</code> object to Rails API. JavaScript&#39;s <code>JSON.parse()</code> serializes <code>Date</code> into a string of ISO 8601 format in UTC time zone. This is problematic to the people on the east side of the prime meridian because they get different date when they express their beginning of date in UTC.</p>\n<pre><code class=\"hljs javascript\"><span class=\"hljs-built_in\">JSON</span>.stringify({ date: <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>(<span class=\"hljs-number\">2015</span>, <span class=\"hljs-number\">3</span> - <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>) });\n<span class=\"hljs-comment\">// '{\"date\":\"2015-03-01T15:00:00.000Z\"}'</span></code></pre><p>I could have controlled front-end code to always send date string like <code>&#39;2015-03-02&#39;</code> or converted the ISO 8601 string with <code>Time.zone.parse</code> in Rails controllers. But those approaches seemed error prone. I wanted to take care of it at the bottom, ActiveRecord model. I created a concern to override <code>date</code>-column mutators like the following. It converts <code>Time</code> and time string to <code>TimeWithZone</code> with the application&#39;s time zone.</p>\n<pre><code class=\"hljs undefined\">def birth_date=(value)\n  self[:birth_date] = case value\n                      when String then Time.zone.parse(value)\n                      when Time then value.in_time_zone\n                      else value\n                      end\nend</code></pre><p>The concern was extracted as a gem, <a href=\"https://github.com/shuhei/date_timezone\">date_timezone</a>.</p>\n<pre><code class=\"hljs Gemfile\">gem 'date_timezone'</code></pre><pre><code class=\"hljs ruby\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Person</span> <span class=\"hljs-inheritance\">&lt; <span class=\"hljs-parent\">ActiveRecord::Base</span></span></span>\n  <span class=\"hljs-keyword\">include</span> <span class=\"hljs-constant\">DateTimezone</span>\n\n  <span class=\"hljs-comment\"># birth_date :date</span>\n<span class=\"hljs-keyword\">end</span></code></pre><p>If you are creating Rails application on the east side of the prime meridian and in trouble with the same issue as mine, please try it and share what you think.</p>\n"}}