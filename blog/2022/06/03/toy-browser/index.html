<!doctype html><html lang="en"><head><meta charset="utf-8"><link rel="preload" href="https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthqQBK6PYK0.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWxEQDO-Wyrs.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNZaxMaC82U.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librefranklin/v12/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkANDPTedX18mE.woff" as="font" crossorigin="anonymous"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><meta name="viewport" content="width=device-width,initial-scale=1"><title>Building a toy browser</title><link rel="icon" sizes="16x16 32x32 48x48" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="Atom feed of Shuhei Kagawa" href="/blog/feed.xml"><style>:root{--bg-color:#f9f9f9;--text-color:#222;--highlight-color:#095ae8;--code-text-color:var(--code-mono-1);--code-bg-color:#fff;--syntax-hue:230;--syntax-saturation:1%;--syntax-brightness:100%;--code-mono-1:hsl(var(--syntax-hue), 8%, 24%);--code-mono-2:hsl(var(--syntax-hue), 6%, 44%);--code-mono-3:hsl(var(--syntax-hue), 4%, 64%);--code-hue-1:hsl(198, 99%, 37%);--code-hue-2:hsl(221, 76%, 47%);--code-hue-3:hsl(301, 63%, 40%);--code-hue-4:hsl(119, 72%, 31%);--code-hue-5:hsl(5, 68%, 48%);--code-hue-5-2:hsl(344, 84%, 43%);--code-hue-6:hsl(41, 99%, 30%);--code-hue-6-2:hsl(41, 99%, 30%);--body-font-family:"Libre Baskerville",serif;--heading-font-family:"Libre Franklin",sans-serif;--code-font-family:"DM Mono",monospace}body{font-family:"Libre Baskerville",serif;font-family:var(--body-font-family);background:#f9f9f9;background:var(--bg-color);color:#222;color:var(--text-color);padding:0;margin:0;font-size:16px;line-height:1.9}.container{width:700px;padding:0 20px;margin:0 auto}a{color:#095ae8;color:var(--highlight-color);transition:color .5s ease;text-decoration:none}a:hover{text-decoration:underline}.header{padding:1.5em 0 1em;display:flex}.header__title{margin:0 10px 0 0;flex-grow:1;font-size:1em;font-weight:400}.header__title a{color:#222;color:var(--text-color)}.header__nav{flex-grow:0}.menu{list-style-position:outside;list-style-type:none;padding:0;margin:0;text-align:right}.menu__item{display:inline-block;padding:0 0 0 .7em}.menu__item a{color:#222;color:var(--text-color)}.footer{padding:3em 0 4em;text-align:center}.title{font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-size:3em;margin:0 0 .2em;line-height:1.1}.title a{color:#222;color:var(--text-color);text-decoration:none}.post,.post-list{padding:1.7em 0 1.25em}.post:after{content:"* * *";font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-weight:700;font-size:4.5em;display:block;margin:.9em auto 0;text-align:center;line-height:1}.post .meta{font-size:.75em}.post-list .title{margin-bottom:10px}.post-list-item{line-height:1.6em;padding:10px 0;display:flex}.post-list-item__date{font-size:.8em;width:8em;flex-shrink:0}.post-list-item__title{font-size:1.3em;margin:0;font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-weight:700}.post-list-item__title a{text-decoration:none;color:#222;color:var(--text-color)}.content h2,.content h3,.content h4,.content h5,.content h6{font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);margin:1em 0 0 0}.content h2{font-size:2.2em;line-height:1.1}.content h3{font-size:1.6em;line-height:1.3}.content h4{font-size:1.2em}.content img{max-width:100%;height:auto}.content p{margin:1.15em 0}.img-wrapper{display:block;text-align:center}.comments{margin-bottom:3em}ol,ul{list-style-position:outside;padding-left:1.4em}.table-wrapper{overflow-x:auto;margin:1.15em 0}.table-wrapper table{border-collapse:collapse;margin:0;width:100%}tr{vertical-align:top}th{font-weight:400;text-align:left}tbody{border-top:1px solid #333;border-bottom:1px solid #333;padding:.5em 0}td,th{padding-right:1em}code{color:#383942;color:var(--code-text-color);background-color:#fff;background-color:var(--code-bg-color);font-size:.9em;font-family:"DM Mono",monospace;font-family:var(--code-font-family);padding:0 .3em}.code__filename{display:inline-block;margin-bottom:13px;padding:5px 10px;font-size:.85em;background-color:#666}.hljs{display:block;line-height:1.5em;padding:1em 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;color:#383942;color:var(--code-text-color);background-color:#fff;background-color:var(--code-bg-color)}.hljs-comment,.hljs-quote{color:#696b76;color:var(--code-mono-2);font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a625a4;color:var(--code-hue-3)}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#cd3527;color:var(--code-hue-5)}.hljs-literal{color:#0083bb;color:var(--code-hue-1)}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#188716;color:var(--code-hue-4)}.hljs-built_in,.hljs-class .hljs-title{color:#986800;color:var(--code-hue-6-2)}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986800;color:var(--code-hue-6)}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#1c56d2;color:var(--code-hue-2)}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}blockquote{font-style:italic;padding:0 0 0 2em;margin:1.5em 0}blockquote p:first-child:before{content:open-quote;font-family:serif;font-size:3em;font-weight:700;line-height:.1em;margin-right:.2em;vertical-align:-.4em}blockquote cite{color:#999990}blockquote cite:before{content:"- "}.pagination{list-style-position:outside;list-style-type:none;padding:0;margin-top:20px;display:flex;justify-content:space-between}.pagination__next-page,.pagination__prev-page{width:46%}.pagination__next-page{text-align:right}.footer-nav{text-align:center}@media only screen and (max-width:767px){body{font-size:15px;line-height:1.65}.container{width:auto}.post,.post-list{padding-top:10px}.post-list-item{display:block}.hljs{margin-left:-20px;margin-right:-20px;padding:1.4em 20px;border-radius:0}li .hljs{margin-left:0}.img-wrapper{margin-left:-20px;margin-right:-20px}}@font-face{font-family:'DM Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthSQBK6PYK3EXw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'DM Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthqQBK6PYK0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Libre Baskerville';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWx8QDO-WyrubOA.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Libre Baskerville';font-style:italic;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWxEQDO-Wyrs.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Libre Baskerville';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNXaxMaC82U-ro.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Libre Baskerville';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNZaxMaC82U.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Libre Franklin';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/librefranklin/v12/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkD9DPTedX18mETQw.woff) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Libre Franklin';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/librefranklin/v12/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkDtDPTedX18mETQw.woff) format('woff');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Libre Franklin';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/librefranklin/v12/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkANDPTedX18mE.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><meta name="description" content="A personal website of Shuhei Kagawa. I write mostly on web technologies and life."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@shuheikagawa"><meta property="og:title" content="Building a toy browser"><meta property="og:site_name" content="Shuhei Kagawa"><meta property="og:description" content="A personal website of Shuhei Kagawa. I write mostly on web technologies and life."><meta property="og:image" content="https://shuheikagawa.com/cached/985aa0b6-680.png"></head><body><div class="container"><header class="header"><h1 class="header__title"><a href="/">Shuhei Kagawa</a></h1><nav class="header__nav"><ul class="menu"><li class="menu__item"><a href="/about/">About</a></li><li class="menu__item"><a href="/blog/archives/">All posts</a></li></ul></nav></header><div class="main"><div class="post"><div class="post-header"><h1 class="title">Building a toy browser</h1><div class="meta"><span class="date">Jun 3, 2022</span> - <a href="/blog/tags/Browser">Browser</a>, <a href="/blog/tags/CSS">CSS</a>, <a href="/blog/tags/Python">Python</a></div></div><div class="content"><div><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/985aa0b6-700.avif 700w, /cached/985aa0b6-900.avif 900w, /cached/985aa0b6-1100.avif 1100w, /cached/985aa0b6-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/985aa0b6-700.webp 700w, /cached/985aa0b6-900.webp 900w, /cached/985aa0b6-1100.webp 1100w, /cached/985aa0b6-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/985aa0b6-700.png 700w, /cached/985aa0b6-900.png 900w, /cached/985aa0b6-1100.png 1100w, /cached/985aa0b6-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img src="/cached/985aa0b6-700.png" width="700" height="501" alt="Screenshot of my toy browser showing this website" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FZQUFBRGFtMmRnQUFBQUNYQklXWE1BQUJZbEFBQVdKUUZKVWlUd0FBQUJEa2xFUVZRWTB3RURBZnorQU9IaDRjUGk0dU8wNCtQa3QrRGg0YmZpNHVPMzR1TGp0K0xqNDdYajQrVEEyZG5aU0FEMTlmWC82T2puLytUazQvL2s1T1QvNXVibS8rM3M3UC96OHZMLzlQVDAvK2ZuNW1zQSsvdjcvK0xrNXZqajV1Zjg3dS92L096dDd2ejMrdno4L2Y3LytmajQrUC9zN094bEFQcjYrLy9lenNUN3liS24vcCtabWY2cW9aeisxTHl0L3VmYjFQejYvUDMvNnVub1pnRDYrL3oveHFlVjkyNU5QUHVBYUUzN2YybE8rMzVZUS9yWXY3SDQvUC8vLytQaDRHUUEvdi8vLzdhZGtmOXJUVGIvcnNiQS82T3NtLzlxU0RMLzByNnovLzcvLy8vbTVPTnRBTjdnNEl5aWlYdUNVend2aEh5Umo0UnVmbjJFVnprb2hMbW1tNExoNU9XS3pzM01OQi9PeDUzVm5wY0FBQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')"></picture></span></p><p>In the last several weeks, I have been building a toy browser based on an online book, <a href="https://browser.engineering">Browser Engineering</a>. As someone who spent a fair share of his career on web frontend, it was eye-opening and satisfying. It felt like I had been living on one side of a wall for years and finally visited the other side of the wall. I imagine other web frontend folks would like it as well.</p><h2>The book</h2><p><a href="https://browser.engineering/">Browser Engineering</a> is an online book by Pavel Panchekha and Chris Harrelson. It explains how browsers work and lets you implement a toy browser almost from scratch. HTTP, CSS parser, HTML parser, rendering pipeline (style, layout, paint), the interaction between browser window and tabs, JavaScript, animation, and the list goes on. It uses only a handful of libraries such as TCP and Tkinter (replaced by Skia and SDL in later chapters).</p><p>I discovered it on Twitter. Once I started reading the book, I was hooked. It presents succinct code to implement browser features incrementally. You are always with working code.</p><p>Each topic lays a good foundation that you can build upon and links to relevant resources. Exercises let you implement features on your own.</p><p>Even before reading the book, I had read a good amount of articles about how browsers work <em>from outside</em>. The book explained concepts in a way that readers could implement them. I learned a lot.</p><h2>Beyond the book</h2><p>I wanted to render real-world websites. Well, real-world websites on the simpler side. Not JavaScript-driven applications. HTML, CSS, and a bit of JavaScript. This website and the book's website were my main targets. Wikipedia was a stretch goal.</p><p>The goal has been partially achieved.</p><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/f1b32bf1-700.avif 700w, /cached/f1b32bf1-900.avif 900w, /cached/f1b32bf1-1100.avif 1100w, /cached/f1b32bf1-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/f1b32bf1-700.webp 700w, /cached/f1b32bf1-900.webp 900w, /cached/f1b32bf1-1100.webp 1100w, /cached/f1b32bf1-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/f1b32bf1-700.png 700w, /cached/f1b32bf1-900.png 900w, /cached/f1b32bf1-1100.png 1100w, /cached/f1b32bf1-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img src="/cached/f1b32bf1-700.png" width="700" height="501" alt="Screenshot of the toy browser showing Web Browser Engineering Chapter 11" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FZQUFBRGFtMmRnQUFBQUNYQklXWE1BQUJZbEFBQVdKUUZKVWlUd0FBQUE0MGxFUVZRWTB5V01RVTdETUJCRmZTZ093VUdBRGVJU1ZWYUk0NERZcGdsVXJLcXNLRjBReDdWako3YnJGRmRwbk5qTllNcElUMzgwZi81SEZTRjU1Rm5LOWxVSWNZR3hPc0plS0dYcDEzWjdqYnozb0pTR3FxSkFDQVBPR3hqSEVhWnBBdWNjU0NudkVjU3h0bmVFNkZDV01uQytEeUg0RU0vanYyZHZVZGQxTVYzN3BoR3pFUFZjMXl3cWorcUR0VFAwL2VFT2FhMEJZendJMGZoWUhWSCtlTFJUV1o2ZE1UTU13K0VHR1dPQVVncC96MHJ0b1czbFpkL3R6ckVGNEhUNmVVQkZVVHhsV2JaWXJkNlROUDFJbHNzc3lmTzNaTDMrWG1CTUhqZWJ6NnRmK1k3ZStidDhhQThBQUFBQVNVVk9SSzVDWUlJPSI+CiAgICA8L2ltYWdlPgogIDwvc3ZnPg==')"></picture></span></p><p>Even for rendering simple websites, I had to implement or revamp numerous browser features beyond the book.</p><h3>HTML</h3><p>I revamped the recursive descent HTML parser from the book to support quoted attributes, raw text elements, etc. Among HTML, CSS, and JavaScript (ECMAScript), the HTML spec was the easiest to read and implement (partially).</p><p>Fun facts:</p><ul><li><a href="https://html.spec.whatwg.org/multipage/parsing.html#determining-the-character-encoding">Browsers are supposed to <em>sniff</em> the character encoding of a web page</a></li><li><a href="https://html.spec.whatwg.org/multipage/syntax.html#optional-tags">HTML spec has quite detailed rules for tag omission</a></li><li><a href="https://html.spec.whatwg.org/multipage/parsing.html#an-introduction-to-error-handling-and-strange-cases-in-the-parser">HTML spec explains how to handle invalid markups</a> like <code>&lt;b&gt;&lt;i&gt;&lt;/b&gt;&lt;/i&gt;</code>. HTML parser never fails!</li></ul><h3>CSS and rendering</h3><p>I was drawn to implementing CSS features. CSS is more forgiving than JavaScript—at least for a toy browser. Even if my toy browser missed most of the CSS features, it still rendered something on the screen. On the other hand, JavaScript halts execution on a single missing syntax or feature. I would need to implement a bunch of browser APIs until the toy browser could run real-world scripts. So, I focused on CSS and rendering for the toy browser.</p><p>While I was working on the project, my best friends were <a href="https://developer.mozilla.org">MDN</a> and CSS specs (<a href="https://www.w3.org/TR/CSS22/">CSS 2</a> and <a href="https://www.w3.org/Style/CSS/specs.en.html">more</a>). Yes, there are quite readable.</p><p>One surprise for me was that CSS syntax doesn’t say much about property values. Each property has own syntax. For example, <code>font-family</code> and <code>animation</code> have different precedence rules for commas and spaces.</p><p><code>font-family</code> puts commas higher precedence than spaces:</p><pre><code class="hljs css"><span class="hljs-comment">/* (1.6em) (bold) (Helvetica, Arial, sans-serif) */</span>
<span class="hljs-selector-tag">font-family</span>: 1<span class="hljs-selector-class">.6em</span> <span class="hljs-selector-tag">bold</span> <span class="hljs-selector-tag">Helvetica</span>, <span class="hljs-selector-tag">Arial</span>, <span class="hljs-selector-tag">sans-serif</span>;
</code></pre><p><code>animation</code> does the other way around:</p><pre><code class="hljs css"><span class="hljs-comment">/* (slidein 3s), (move 10s) */</span>
<span class="hljs-selector-tag">animation</span>: <span class="hljs-selector-tag">slidein</span> 3<span class="hljs-selector-tag">s</span>, <span class="hljs-selector-tag">move</span> 10<span class="hljs-selector-tag">s</span>;
</code></pre><p>The book skipped whitespace handling but it was necessary for nice-looking code blocks (<code>white-space: pre</code>). The CSS spec has <a href="https://www.w3.org/TR/css-text-3/#white-space-rules">elaborate rules for ignoring and collapsing whitespace</a>. I made up a greedy algorithm instead of implementing the full spec. It's not 100% accurate, but it looks alright.</p><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/60f6643d-700.avif 700w, /cached/60f6643d-900.avif 900w, /cached/60f6643d-1100.avif 1100w, /cached/60f6643d-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/60f6643d-700.webp 700w, /cached/60f6643d-900.webp 900w, /cached/60f6643d-1100.webp 1100w, /cached/60f6643d-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/60f6643d-700.png 700w, /cached/60f6643d-900.png 900w, /cached/60f6643d-1100.png 1100w, /cached/60f6643d-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img src="/cached/60f6643d-700.png" width="700" height="501" alt="Screenshot of the toy browser showing a page with code blocks" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FZQUFBRGFtMmRnQUFBQUNYQklXWE1BQUJZbEFBQVdKUUZKVWlUd0FBQUF4VWxFUVZRWTB6MlBUUTZDTUJDRmV5Z1A0VUhVamZFU3hwWHhPQnEySnJMakJJUVFTUXZ5VHdPRXRLV2s0d3lKTHI2OFNmdmV2SmE5ay9lTGMzRXZpc0pMMDh6THNvK1g1K3Y4RUVJOHd6RGNzcklzQVEwZ3BZU3U2LzZxbEFKakROUjFmV1IweUlYUW1Gb0lEQ3hWVlMwQVlCQUs3Rm5mOTREYmJOTTBqbWpiMXVFRjZUS09Jd3pEY0dDem1rRjJVbW10clhQdXg0d0dUWldvTzJhMElmZmFUMWhycVdWOUcyMmFwdW5Fb2lpNjRRL09uUE5Ma2lRck5QdStmdzZDNEJySDhlWUxrZGJpWkoyWm5pSUFBQUFBU1VWT1JLNUNZSUk9Ij4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')"></picture></span></p><p>Web fonts were essential to make my toy browser look nice. I revamped the CSS parser to support the <code>@font-face</code> rule and implemented rudimentary font synthesis and font matching. Skia took care of the actual rendering.</p><p>I also learned a few things about the inline layout (or normal flow). The box model is considered to be a basic for frontend developers. But did you know how the inline layout works? What's the difference between <code>line-height: 1</code> and <code>line-height: 1em</code>? Why doesn't vertical-align help vertical centering? <a href="https://iamvdo.me/en/blog/css-font-metrics-line-height-and-vertical-align">Deep dive CSS: font metrics, line-height and vertical-align</a> by Vincent De Oliveira is an amazing article that explains those things.</p><p>Fun facts:</p><ul><li><a href="https://www.youtube.com/watch?v=Y5Xa4H2wtVA">Margin collapsing and float are hilariously complex</a>.</li><li><a href="https://www.w3.org/TR/css-fonts-4/#font-style-matching">CSS Fonts Module</a> has line charts to explain the font matching algorithm. Browsers try their best to pick fonts for you without you even noticing it.</li><li><a href="https://www.w3.org/TR/css-lists-3/">The list counter spec</a> is quite advanced. You can create counters, increment them and use them as part of <code>content</code> in CSS.</li></ul><h3>Other stuff</h3><p>I also implemented other stuff.</p><ul><li>Retina display to make the toy browser look good on my laptop</li><li>Window resizing: SDL doesn’t seem to provide a good API for resizing</li><li>URL parsing: Parsing URLs into objects made it easier to implement many other parts of the project. I should have done it earlier.</li><li>Content Security Policy: The CSP implementation from the book blocks legitimate requests. I implemented the bare minimum to allow legitimate resource loading.</li></ul><h2>Python</h2><p>The book uses Python for good reasons. I followed the path and used Python because I wanted to focus on the subject instead of spending time on <em>how to do X in Y language</em>. I had already made enough (fun) mistakes of this kind in my life.</p><p>Also, I was not that familiar with Python. Before starting the project, I hadn’t written much Python. It's used in many places. Good chance to learn it. Now I like the syntax.</p><p>I used <a href="https://github.com/microsoft/pyright">pyright</a> for static type-checking along with <a href="https://github.com/fannheyward/coc-pyright">coc-pyright</a> on Vim. Its type inference worked quite well for me. It uses a gradual typing approach similar to TypeScript although Python’s type annotation is part of the language specification. Python’s typing features don’t look as powerful as TypeScript, but they met more than 90% of my needs. Also, auto-completion was helpful for a Python beginner.</p><p>My toy browser uses only a handful of third-party libraries. They either had type annotations or had only small little surface in my toy browser. The only exception was <a href="https://github.com/kyamagu/skia-python">skia-python</a>. I used it a lot. It didn’t have official type stubs, so <a href="https://github.com/kyamagu/skia-python/issues/133#issuecomment-1066141203">I generated them with mypy's stubgen</a>. The generated stubs were not perfect but good enough as a foundation to build upon for my limited use case.</p><p>I used <a href="https://github.com/psf/black">black</a> for code formatting and <a href="https://github.com/pytest-dev/pytest/">pytest</a> for unit testing. I don't have much to say about them because they <em>just worked™</em>.</p><h2>Conclusion</h2><p>It’s been a fun side project with lots of learning. I imagine other web frontend folks would like it as well. I recommend you check out <a href="https://browser.engineering">the book</a> and build your own toy browser!</p></div></div></div><ul class="pagination"><li class="pagination__prev-page"></li><li class="pagination__next-page"><a href="/blog/2021/12/31/2021-in-review/">2021 in review</a></li></ul><nav class="footer-nav"><a href="/blog/archives/">All posts</a></nav></div><footer class="footer">© Shuhei Kagawa</footer></div></body></html>