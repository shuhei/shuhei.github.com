<!doctype html><html lang="en"><head><meta charset="utf-8"><link rel="preload" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Libre+Baskerville:ital@0;1&amp;family=Libre+Franklin:wght@700&amp;family=DM+Mono" as="style"><link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v9/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNZaxMaC82U.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librefranklin/v6/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkANDPTedX18mE.woff" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/dmmono/v3/aFTU7PB1QTsUX8KYthqQBK6PYK0.woff2" as="font" crossorigin="anonymous"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><meta name="viewport" content="width=device-width,initial-scale=1"><title>Shuhei Kagawa</title><link rel="icon" sizes="16x16 32x32 48x48" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" title="RSS Feed for shuheikagawa.com" href="/blog/feed/rss.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-309586-8', 'shuheikagawa.com');
      ga('send', 'pageview');</script><style>:root{--bg-color:#f9f9f9;--text-color:#222;--highlight-color:#095ae8;--code-text-color:var(--code-mono-1);--code-bg-color:#fff;--syntax-hue:230;--syntax-saturation:1%;--syntax-brightness:100%;--code-mono-1:hsl(var(--syntax-hue), 8%, 24%);--code-mono-2:hsl(var(--syntax-hue), 6%, 44%);--code-mono-3:hsl(var(--syntax-hue), 4%, 64%);--code-hue-1:hsl(198, 99%, 37%);--code-hue-2:hsl(221, 76%, 47%);--code-hue-3:hsl(301, 63%, 40%);--code-hue-4:hsl(119, 72%, 31%);--code-hue-5:hsl(5, 68%, 48%);--code-hue-5-2:hsl(344, 84%, 43%);--code-hue-6:hsl(41, 99%, 30%);--code-hue-6-2:hsl(41, 99%, 30%);--body-font-family:"Libre Baskerville",serif;--heading-font-family:"Libre Franklin",sans-serif;--code-font-family:"DM Mono",monospace}body{font-family:"Libre Baskerville",serif;font-family:var(--body-font-family);background:#f9f9f9;background:var(--bg-color);color:#222;color:var(--text-color);padding:0;margin:0;font-size:16px;line-height:1.9}.container{width:700px;padding:0 20px;margin:0 auto}a{color:#095ae8;color:var(--highlight-color);transition:color .5s ease}a:hover{opacity:.7}.header{padding:1.5em 0 1em;display:flex}.header__title{margin:0 10px 0 0;flex-grow:1;font-size:1em;font-weight:400}.header__title a{color:#222;color:var(--text-color);text-decoration:none}.header__nav{flex-grow:0}.menu{list-style-position:outside;list-style-type:none;padding:0;margin:0;text-align:right}.menu__item{display:inline-block;padding:0 0 0 .7em}.menu__item a{color:#222;color:var(--text-color);text-decoration:none}.footer{padding:3em 0 4em;text-align:center}.title{font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-size:3em;margin:0 0 .2em;line-height:1.1}.title a{color:#222;color:var(--text-color);text-decoration:none}.post,.post-list{padding:1.7em 0 1.25em}.post:not(:first-child):before{content:"* * *";font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-weight:700;font-size:4em;display:block;margin:.2em auto .6em;text-align:center;line-height:1}.post .meta{font-size:.75em}.post-list .title{margin-bottom:10px}.post-list-item{line-height:1.6em;padding:10px 0;display:flex}.post-list-item__date{font-size:.8em;width:8em;flex-shrink:0}.post-list-item__title{font-size:1.3em;margin:0;font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);font-weight:700}.post-list-item__title a{text-decoration:none;color:#222;color:var(--text-color)}.content h2,.content h3,.content h4,.content h5,.content h6{font-family:"Libre Franklin",sans-serif;font-family:var(--heading-font-family);margin:1em 0 0 0}.content h2{font-size:2.2em;line-height:1.1}.content h3{font-size:1.6em;line-height:1.3}.content h4{font-size:1.2em}.content img{max-width:100%;height:auto}.content p{margin:1.15em 0}.social-buttons{margin:2em 0 0}.comments{margin-bottom:3em}ol,ul{list-style-position:outside;padding-left:1.4em}.table-wrapper{overflow-x:auto}table{border-collapse:collapse;margin:2em 0}th{font-weight:400;text-align:left}tbody{border-top:1px solid #333;padding:.5em 0}td,th{padding-right:1em}code{color:#383942;color:var(--code-text-color);background-color:#fff;background-color:var(--code-bg-color);font-size:.9em;font-family:"DM Mono",monospace;font-family:var(--code-font-family)}.code__filename{display:inline-block;margin-bottom:13px;padding:5px 10px;font-size:.85em;background-color:#666}.hljs{display:block;line-height:1.5em;padding:1em 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;color:#383942;color:var(--code-text-color);background-color:#fff;background-color:var(--code-bg-color)}.hljs-comment,.hljs-quote{color:#696b76;color:var(--code-mono-2);font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a625a4;color:var(--code-hue-3)}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#cd3527;color:var(--code-hue-5)}.hljs-literal{color:#0083bb;color:var(--code-hue-1)}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#188716;color:var(--code-hue-4)}.hljs-built_in,.hljs-class .hljs-title{color:#986800;color:var(--code-hue-6-2)}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986800;color:var(--code-hue-6)}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#1c56d2;color:var(--code-hue-2)}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}blockquote{border-left:5px solid #222;border-left:5px solid var(--text-color);font-style:italic;padding:.1em 1.2em;margin-left:0;quotes:"\201C""\201D""\2018""\2019"}blockquote p:first-child:before{content:open-quote;font-family:serif;font-size:3em;font-weight:700;line-height:.1em;margin-right:.2em;vertical-align:-.4em}blockquote cite{color:#999990}blockquote cite:before{content:"- "}.pagination{list-style-position:outside;list-style-type:none;padding:0;margin-top:20px;display:flex;justify-content:space-between}.pagination li{min-height:1em}.pagination a{text-decoration:none}.pagination__next-page,.pagination__prev-page{width:35%}.pagination__next-page{text-align:right}.pagination__archives{flex-grow:1;text-align:center}@media only screen and (max-width:767px){body{font-size:15px;line-height:1.65}.container{width:auto}.post,.post-list{padding-top:10px}.post-list-item{display:block}.hljs{margin-left:-20px;margin-right:-20px;padding:1.4em 20px;border-radius:0}li .hljs{margin-left:0}.img-wrapper{margin-left:-20px;margin-right:-20px}}</style><link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Libre+Baskerville:ital@0;1&amp;family=Libre+Franklin:wght@700&amp;family=DM+Mono"><meta name="description" content=""><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@shuheikagawa"><meta property="og:title" content="Shuhei Kagawa"><meta property="og:site_name" content="Shuhei Kagawa"><meta property="og:description" content=""></head><body><div class="container"><header class="header"><h1 class="header__title"><a href="/">Shuhei Kagawa</a></h1><nav class="header__nav"><ul class="menu"><li class="menu__item"><a href="/about/">About</a></li><li class="menu__item"><a href="/blog/archives/">All posts</a></li></ul></nav></header><div class="main"><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2020/02/14/switching-colorschemes-of-vim-and-alacritty/">Switching color schemes of Vim and Alacritty</a></h1><div class="meta"><span class="date">Feb 14, 2020</span> - Vim</div></div><div class="content"><div><p>I like fountain pens and good notebooks. They spark joy when I write on paper. Computer terminals are like stationery. A good terminal setup makes it fun to work with computers. Here is how I improved colors on my terminal and made it easy to switch them depending on the time and the mood.</p><p></p><div class="img-wrapper"><img src="/images/light-terminal.png" alt="Ayu Light for Vim and Alacritty" loading="lazy" decoding="async" width="700" height="446"></div><p></p><h2>Using official color schemes</h2><p>I have been using Dracula color scheme on Vim and Alacritty for a while. I liked the colors, but I had a small problem with it on Vim. The pop-up of <code>coc.nvim</code> had the same color as the background color, and it was hard to distinguish a pop-up and the background.</p><p></p><div class="img-wrapper"><img src="/images/vim-dracula-old.png" alt="dracula from flazz/vim-colorschemes" loading="lazy" decoding="async" width="700" height="167"></div><p></p><p>I was using Dracula from <a href="https://github.com/flazz/vim-colorschemes">vim-colorschemes</a>, which hadn't been updated for three years. I tried <a href="https://github.com/dracula/vim">the official Dracula color scheme for Vim</a>. It had a different background color for pop-ups! Yes, it's subtle, but now I can distinguish pop-ups from the background.</p><p></p><div class="img-wrapper"><img src="/images/vim-dracula-official.png" alt="dracula from dracula/vim" loading="lazy" decoding="async" width="700" height="167"></div><p></p><p><a href="https://github.com/flazz/vim-colorschemes">vim-colorschemes</a> is a great way to try out different color schemes. You can get a random color scheme by <code>:colorscheme random</code>. But once you pick a few favorite ones, it's worth checking if they have official color schemes that are likely to be more maintained.</p><p>The same goes for Alacritty. I was using the Dracula color scheme that I converted with <a href="https://github.com/shuhei/colortty">my tool</a> from <a href="https://github.com/mbadolato/iTerm2-Color-Schemes">iTerm2-Color-Schemes</a> for Alacritty. Dracula has <a href="https://github.com/dracula/alacritty">its official Alacritty theme</a>, and it looks better!</p><h2>termguicolors</h2><p>I started trying other color schemes and found Vim's <code>termguicolors</code> option in <a href="https://github.com/ayu-theme/ayu-vim">ayu-vim</a>'s README. It enables true colors (24-bit colors) instead of 256 colors (8-bit).</p><pre><code class="hljs vim"><span class="hljs-keyword">if</span> <span class="hljs-built_in">has</span>(<span class="hljs-string">'termguicolors'</span>)
  <span class="hljs-keyword">set</span> termguicolors
<span class="hljs-keyword">endif</span>
</code></pre><p>I turned it on, and the colors looked gorgeous! Before learning about <code>termguicolors</code>, I had tried light color schemes like Ayu Light and given up because of too low contrast (left in the following image). With <code>termguicolors</code>, light color schemes became finally usable!</p><p></p><div class="img-wrapper"><img src="/images/vim-light-colorscheme.png" alt="ayu light in 256 colors and true colors" loading="lazy" decoding="async" width="700" height="446"></div><p></p><h2>Switching color schemes</h2><p>After trying dozens of color schemes, I picked the following:</p><ul><li><a href="https://github.com/ayu-theme/ayu-vim">Ayu</a> Light: Good in the morning or at a place with natural light.</li><li><a href="https://github.com/sts10/vim-pink-moon">Pink Moon</a></li><li><a href="https://github.com/arcticicestudio/nord-vim">Nord</a>: Low-contrast theme. Good in the night.</li></ul><p>I started switching color schemes depending on the time and the mood and bumped into a couple of issues. It was tedious to update the color schemes of Vim and Alacritty together. Also, I manage my <code>.alacritty.yml</code> and <code>.vimrc</code> in a git repository. It was annoying that the repository had unstaged changes every time I switched color schemes.</p><h2>Solution</h2><h3>Alacritty</h3><p>I decided to remove <code>.alacritty.yml</code> from the git repository and generate it out of a base template and color scheme files. Once I prepared a YAML file for each color scheme, it was quite easy with a one-liner.</p><pre><code class="hljs sh">cat alacritty/base.yml alacritty/<span class="hljs-variable">${color}</span>.yml &gt; .alacritty.yml
</code></pre><h3>Vim</h3><p>I could have generated <code>.vimrc</code>, but it felt weird because VimScript is a programming language. Instead of generating the whole <code>.vimrc</code>, I decided to generate a color scheme file <code>.vim/color.vim</code>, which is in <code>.gitignore</code></p><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">'let ayucolor="light"\ncolorscheme ayu'</span> &gt; ~/.vim/color.vim
</code></pre><p>and load it from <code>.vimrc</code>.</p><pre><code class="hljs vim"><span class="hljs-keyword">let</span> color_path = <span class="hljs-built_in">expand</span>(<span class="hljs-string">'~/.vim/color.vim'</span>)
<span class="hljs-keyword">if</span> <span class="hljs-built_in">filereadable</span>(color_path)
  exec <span class="hljs-string">'source'</span> color_path
<span class="hljs-keyword">else</span>
  <span class="hljs-comment">" Default color scheme</span>
  <span class="hljs-keyword">colorscheme</span> pink-moon
<span class="hljs-keyword">endif</span>
</code></pre><h3>Putting them together</h3><p>Then, I created a shell script named <code>colorscheme</code> to switch color schemes of Vim and Alacritty together.</p><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh
</span>
color=<span class="hljs-variable">$1</span>
dotfiles=~/dotfiles
alacritty=<span class="hljs-variable">${dotfiles}</span>/alacritty

<span class="hljs-function"><span class="hljs-title">configure_alacritty</span></span>() {
  cat <span class="hljs-variable">${alacritty}</span>/base.yml <span class="hljs-variable">${alacritty}</span>/<span class="hljs-variable">${color}</span>.yml &gt; <span class="hljs-variable">${dotfiles}</span>/.alacritty.yml
}

<span class="hljs-function"><span class="hljs-title">configure_vim</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span> &gt; <span class="hljs-variable">${dotfiles}</span>/.vim/color.vim
}

<span class="hljs-keyword">case</span> <span class="hljs-variable">$color</span> <span class="hljs-keyword">in</span>
  dracula)
    configure_alacritty
    configure_vim <span class="hljs-string">'colorscheme dracula'</span>
    ;;
  nord)
    configure_alacritty
    configure_vim <span class="hljs-string">'colorscheme nord'</span>
    ;;
  pink-moon)
    configure_alacritty
    configure_vim <span class="hljs-string">'colorscheme pink-moon'</span>
    ;;
  ayu-light)
    configure_alacritty
    configure_vim <span class="hljs-string">'let ayucolor="light"\ncolorscheme ayu'</span>
    ;;
  *)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Supported colorschemes: dracula, nord, pink-moon, ayu-light"</span>
    <span class="hljs-built_in">exit</span> 1
    ;;
<span class="hljs-keyword">esac</span>
</code></pre><p>Now I can switch color schemes with only one command! (I still need to restart/reload open Vim sessions, but I can live with it.)</p><pre><code class="hljs sh">colorscheme ayu-light
colorscheme nord
</code></pre><p>If you are curious about the full setup, check out <a href="https://github.com/shuhei/dotfiles">my dotfiles repo</a>.</p><h2>Summary</h2><ul><li>Official color schemes may have more features than color scheme bundles</li><li>Enable <code>termguicolors</code> on Vim</li><li>Switch color schemes with a command!</li></ul></div></div></div><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2020/01/27/goodbye-textile/">Goodbye, Textile</a></h1><div class="meta"><span class="date">Jan 27, 2020</span> - Blog, JavaScript</div></div><div class="content"><div><p><a href="https://en.wikipedia.org/wiki/Textile_(markup_language)">Textile</a> is a markup language that is similar to Markdown. This blog had had posts written in Textile for more than a decade—I feel old now! I removed the Textile files last weekend. This post is a memoir on the markup language.</p><p>I started using Textile on a blog engine called <a href="https://en.wikipedia.org/wiki/Textpattern">Textpattern</a>. I don't remember exactly when, but probably around 2004 or 2005. I was a university student. Movable Type was the most popular blog engine at the time, but it changed its license towards a more commercial one. Textpattern was a new open-source software. I fell in love with its minimalism. There were not many Textpattern users in Japan. Information in Japanese was very little if not none. I read documentation and forums in English and translated some into Japanese with a few fellows whom I had never met in person.</p><p>After a few years, Wordpress became a thing, or I realized it did. Even after I moved to Wordpress, I kept writing in Textile. I liked editing Textile more than editing rich text on WYSIWYG editor. I am not sure whether I had heard of Markdown at the time. But it was not as popular or dominant as it is now.</p><p>I started this blog with Textile on Wordpress in 2008 when I started my first job. And I migrated it to Octopress in 2012. I started writing in Markdown with Octopress because it was the lingua franca of GitHub where all the cool things were happening. I had a bit more than a hundred posts in Textile. I kept them in Textile because Octopress supported Textile as well. In 2014, I rebuilt this blog with a handmade static site generator using Gulp. I carried the old Textile files over. I even wrote <a href="https://github.com/shuhei/gulp-textile">gulp-textile</a> plugin, which was just a thin wrapper of <a href="https://github.com/borgar/textile-js">textile-js</a>. It was my first npm package.</p><p>Since then, I implemented a few Markdown-only features like syntax highlighting and responsive table in this blog. The outputs of Markdown and Textile diverged. Last weekend, I wanted to implement <a href="https://shuheikagawa.com/blog/2020/01/26/responsive-images-with-a-static-site-generator/">responsive images</a>. One more Markdown-only feature. Then I thought it was time to convert the Textile files to Markdown.</p><h2>Converting Textile to Markdown</h2><p>I didn't want to convert a hundred posts by hand. I had tried <a href="https://github.blog/2016-03-01-upgrading-your-textile-posts-to-markdown/">tomd</a> a few years ago, but I was not satisfied with the result. The old Textile files had raw HTML tags and some classes for styling. Also, I was afraid of missing some details that I don't remember anymore. So I decided to write a conversion script.</p><p>I used <a href="https://github.com/borgar/textile-js">textile-js</a> to parse Textile. It turned out that <code>textile-js</code> output HTML string or <a href="http://www.jsonml.org/">JsonML</a>. JsonML was new to me. It is basically HTML in JSON format. Each text node is represented as a string. Each element node is represented as an array whose first item is the tag name, an optional second item is an object of attributes and the rest are child nodes.</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://foo.com"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"foo.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Foo"</span> /&gt;</span> Yay<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre><pre><code class="hljs json">[
  <span class="hljs-string">"a"</span>,
  { <span class="hljs-attr">"href"</span>: <span class="hljs-string">"https://foo.com"</span> },
  [<span class="hljs-string">"img"</span>, { <span class="hljs-attr">"src"</span>: <span class="hljs-string">"foo.png"</span>, <span class="hljs-attr">"alt"</span>: <span class="hljs-string">"Foo"</span> }],
  <span class="hljs-string">" Yay"</span>
]
</code></pre><p>I wrote a <code>switch</code> statement to handle tags and added tag handlers one by one.</p><pre><code class="hljs js"><span class="hljs-keyword">switch</span> (tag) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">"img"</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-comment">/* render &lt;img&gt; */</span>;
  <span class="hljs-keyword">case</span> <span class="hljs-string">"a"</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-comment">/* render &lt;a&gt; */</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown tag: <span class="hljs-subst">${tag}</span>`</span>);
}
</code></pre><p>I also added <code>console.log</code> for unknown attributes. In this way, I was able to make sure that all tags and attributes were handled. <a href="https://github.com/shuhei/shuhei.github.com/pull/44">The script worked well to convert more than one hundred posts</a>. The full script is <a href="https://gist.github.com/shuhei/b622af9559d859d386edbfe43f171d72">on Gist</a>.</p></div></div></div><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2020/01/26/responsive-images-with-a-static-site-generator/">Responsive images with a static site generator</a></h1><div class="meta"><span class="date">Jan 26, 2020</span> - Blog, JavaScript</div></div><div class="content"><div><h2>Responsive images</h2><p>An <code>img</code> without <code>width</code>/<code>height</code> attributes causes a page jump when it's loaded. It happens because the browser doesn't know the dimensions of the image until its data is loaded—only the first part that contains dimensions is enough though. It's common to specify <code>width</code> and <code>height</code> of <code>img</code> tag to avoid the jump.</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/foo.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Foo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span> /&gt;</span>
</code></pre><p>But <code>img</code> tag with <code>width</code> and <code>height</code> doesn't always work well with Responsive Design because the dimensions are fixed. I wanted images to fit the screen width on mobile phones. So I left images without <code>width</code>/<code>height</code> and let them cause page jumps.</p><p>Recently, I came across a similar problem at work and learned a cool technique to create a placeholder of the image's aspect ratio with <code>padding-top</code>. If the image's aspect ratio is <code>height/width = 75/100</code>:</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: relative; padding-top: 75%;"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: absolute; top: 0; left: 0; max-width: 100%;"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre><p>The <code>div</code> works as a placeholder with the image's aspect ratio that fits the width of its containing element. Because the <code>img</code> tag has <code>position: absolute</code>, it doesn't cause a page jump when it's loaded.</p><p>I decided to implement it on this blog. This blog is made with a custom static site generator. I'm not sure if it's useful for anyone else, but I write how I did it anyway…</p><h2>Limiting overstretch</h2><p>In addition to images that are wide enough to always fill the full width of the content area, I had images that are not wide enough to fill the full width of a laptop, but wide enough to fill the full width of a mobile phone. Not to stretch the image on laptops, I decided to go with another wrapper to limit the maximum width of the image. If the image's width is <code>500px</code>:</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"max-width: 500px;"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: relative; padding-top: 75%;"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: absolute; top: 0; left: 0; max-width: 100%;"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre><h2>Getting image dimensions</h2><p>The placeholder technique requires image dimensions. I used <a href="https://github.com/image-size/image-size">image-size module</a> to get image dimensions.</p><p>The following function gets dimensions of images in a directory and returns them as a <code>Map</code>.</p><pre><code class="hljs js"><span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">"util"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-attr">promises</span>: fs } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> sizeOf = util.promisify(<span class="hljs-built_in">require</span>(<span class="hljs-string">"image-size"</span>).imageSize);

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readImageSizes</span>(<span class="hljs-params">dir</span>) </span>{
  <span class="hljs-keyword">const</span> files = (<span class="hljs-keyword">await</span> fs.readdir(dir)).filter(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f.startsWith(<span class="hljs-string">"."</span>));
  <span class="hljs-keyword">const</span> promises = files.map(<span class="hljs-keyword">async</span> file =&gt; {
    <span class="hljs-keyword">const</span> filePath = path.resolve(dir, file);
    <span class="hljs-keyword">const</span> dimensions = <span class="hljs-keyword">await</span> sizeOf(filePath);
    <span class="hljs-keyword">return</span> [file, dimensions];
  });
  <span class="hljs-keyword">const</span> entries = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(promises);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>(entries);
}
</code></pre><h2>Custom renderer of Marked</h2><p>This blog's posts are written in Markdown, and its static site generator uses <a href="https://github.com/markedjs/marked">marked</a> to convert Markdown into HTML. One of my favorite things about <code>marked</code> is that we can easily customize its behavior with a custom renderer.</p><p>I used <code>span</code> tags to wrap <code>img</code> tag because they are rendered in <code>p</code> tag, which can't contain block tags like <code>div</code>.</p><pre><code class="hljs js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomRenderer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">marked</span>.<span class="hljs-title">Renderer</span> </span>{
  image(src, title, alt) {
    <span class="hljs-keyword">const</span> dimensions = <span class="hljs-keyword">this</span>.imageDimensions &amp;&amp; <span class="hljs-keyword">this</span>.imageDimensions.get(src);
    <span class="hljs-keyword">if</span> (dimensions) {
      <span class="hljs-keyword">const</span> { width, height } = dimensions;
      <span class="hljs-keyword">const</span> aspectRatio = (height / width) * <span class="hljs-number">100</span>;
      <span class="hljs-keyword">return</span> (
        <span class="hljs-string">`&lt;span class="responsive-image-wrapper" style="max-width: <span class="hljs-subst">${width}</span>px;"&gt;`</span> +
        <span class="hljs-string">`&lt;span class="responsive-image-inner" style="padding-top: <span class="hljs-subst">${aspectRatio}</span>%;"&gt;`</span> +
        <span class="hljs-string">`&lt;img class="responsive-image" src="<span class="hljs-subst">${src}</span>" alt="<span class="hljs-subst">${alt}</span>"&gt;`</span> +
        <span class="hljs-string">"&lt;/span&gt;"</span> +
        <span class="hljs-string">"&lt;/span&gt;"</span>
      );
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.image(src, title, alt);
  }

  <span class="hljs-comment">// To set images dimensions when images are changed</span>
  setImageDimensions(imageDimensions) {
    <span class="hljs-keyword">this</span>.imageDimensions = imageDimensions;
  }
}
</code></pre><p>And CSS:</p><pre><code class="hljs css"><span class="hljs-selector-class">.responsive-image-wrapper</span> {
  <span class="hljs-attribute">display</span>: block;
}
<span class="hljs-selector-class">.responsive-image-inner</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">position</span>: relative;
}
<span class="hljs-selector-class">.responsive-image</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
}
</code></pre><h2>Result</h2><p>Here are a few examples:</p><ul><li><a href="/blog/2019/12/31/2019-in-review/">Full width on laptop and mobile</a></li><li><a href="/blog/2010/07/10/surface/">Full width on mobile but not on laptop</a></li></ul><p>Yay, no more page jump! Well, web fonts still make the page slightly jump, but that's another story...</p><p>I skipped some details that are specific to my website. The full code is <a href="https://github.com/shuhei/shuhei.github.com/pull/45">on GitHub</a>.</p></div></div></div><ul class="pagination"><li class="pagination__prev-page"><a href="/">Newer posts</a></li><li class="pagination__archives"><a href="/blog/archives/">All posts</a></li><li class="pagination__next-page"><a href="/blog/pages/3/">Older posts</a></li></ul></div><footer class="footer">© Shuhei Kagawa</footer></div></body></html>