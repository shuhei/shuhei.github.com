<!doctype html><html lang="en"><head><meta charset="utf-8"><link rel="preload" href="https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthqQBK6PYK0.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWxEQDO-Wyrs.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNZaxMaC82U.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="https://fonts.gstatic.com/s/librefranklin/v13/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkANDPTedX18mE.woff" as="font" crossorigin="anonymous"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><meta name="viewport" content="width=device-width,initial-scale=1"><title>Shuhei Kagawa</title><link rel="icon" sizes="16x16 32x32 48x48" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="Atom feed of Shuhei Kagawa" href="/blog/feed.xml"><style>:root{--bg-color:#f9f9f9;--text-color:#222;--highlight-color:#095ae8;--code-text-color:var(--code-mono-1);--code-bg-color:#fff;--syntax-hue:230;--syntax-saturation:1%;--syntax-brightness:100%;--code-mono-1:hsl(var(--syntax-hue),8%,24%);--code-mono-2:hsl(var(--syntax-hue),6%,44%);--code-mono-3:hsl(var(--syntax-hue),4%,64%);--code-hue-1:#0184bc;--code-hue-2:#1d56d3;--code-hue-3:#a626a4;--code-hue-4:#188816;--code-hue-5:#ce3527;--code-hue-5-2:#ca1243;--code-hue-6:#986801;--code-hue-6-2:#986801;--body-font-family:"Libre Baskerville",serif;--heading-font-family:"Libre Franklin",sans-serif;--code-font-family:"DM Mono",monospace}body{background:#f9f9f9;background:var(--bg-color);color:#222;color:var(--text-color);font-family:Libre Baskerville,serif;font-family:var(--body-font-family);font-size:16px;line-height:1.9;margin:0;padding:0}.container{margin:0 auto;padding:0 20px;width:700px}a{color:#095ae8;color:var(--highlight-color);text-decoration:none;transition:color .5s ease}a:hover{text-decoration:underline}.header{display:flex;padding:1.5em 0 1em}.header__title{flex-grow:1;font-size:1em;font-weight:400;margin:0 10px 0 0}.header__title a{color:#222;color:var(--text-color)}.header__nav{flex-grow:0}.menu{list-style-position:outside;list-style-type:none;margin:0;padding:0;text-align:right}.menu__item{display:inline-block;padding:0 0 0 .7em}.menu__item a{color:#222;color:var(--text-color)}.footer{padding:3em 0 4em;text-align:center}.title{font-family:Libre Franklin,sans-serif;font-family:var(--heading-font-family);font-size:3em;line-height:1.1;margin:0 0 .2em}.title a{color:#222;color:var(--text-color);text-decoration:none}.post,.post-list{padding:1.7em 0 1.25em}.post:after{content:"* * *";display:block;font-family:Libre Franklin,sans-serif;font-family:var(--heading-font-family);font-size:4.5em;font-weight:700;line-height:1;margin:.9em auto 0;text-align:center}.post .meta{font-size:.75em}.post-list .title{margin-bottom:10px}.post-list-item{display:flex;line-height:1.6em;padding:10px 0}.post-list-item__date{flex-shrink:0;font-size:.8em;width:8em}.post-list-item__title{font-family:Libre Franklin,sans-serif;font-family:var(--heading-font-family);font-size:1.3em;font-weight:700;margin:0}.post-list-item__title a{color:#222;color:var(--text-color);text-decoration:none}.content h2,.content h3,.content h4,.content h5,.content h6{font-family:Libre Franklin,sans-serif;font-family:var(--heading-font-family);margin:1em 0 0}.content h2{font-size:2.2em;line-height:1.1}.content h3{font-size:1.6em;line-height:1.3}.content h4{font-size:1.2em}.content img{height:auto;max-width:100%}.content p{margin:1.15em 0}.img-wrapper{display:block;text-align:center}.comments{margin-bottom:3em}ol,ul{list-style-position:outside;padding-left:1.4em}.table-wrapper{margin:1.15em 0;overflow-x:auto}.table-wrapper table{border-collapse:collapse;margin:0;width:100%}tr{vertical-align:top}th{font-weight:400;text-align:left}tbody{border-bottom:1px solid #333;border-top:1px solid #333;padding:.5em 0}td,th{padding-right:1em}code{background-color:#fff;background-color:var(--code-bg-color);color:#383a42;color:var(--code-text-color);font-family:DM Mono,monospace;font-family:var(--code-font-family);font-size:.9em;padding:0 .3em}.code__filename{background-color:#666;display:inline-block;font-size:.85em;margin-bottom:13px;padding:5px 10px}.hljs{-webkit-overflow-scrolling:touch;background-color:#fff;background-color:var(--code-bg-color);color:#383a42;color:var(--code-text-color);display:block;line-height:1.5em;overflow-x:auto;padding:1em 20px}.hljs-comment,.hljs-quote{color:#696c77;color:var(--code-mono-2);font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4;color:var(--code-hue-3)}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ce3527;color:var(--code-hue-5)}.hljs-literal{color:#0184bc;color:var(--code-hue-1)}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#188816;color:var(--code-hue-4)}.hljs-built_in,.hljs-class .hljs-title{color:#986801;color:var(--code-hue-6-2)}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801;color:var(--code-hue-6)}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#1d56d3;color:var(--code-hue-2)}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}blockquote{font-style:italic;margin:1.5em 0;padding:0 0 0 2em}blockquote p:first-child:before{content:open-quote;font-family:serif;font-size:3em;font-weight:700;line-height:.1em;margin-right:.2em;vertical-align:-.4em}blockquote cite{color:#999990}blockquote cite:before{content:"- "}.pagination{display:flex;justify-content:space-between;list-style-position:outside;list-style-type:none;margin-top:20px;padding:0}.pagination__next-page,.pagination__prev-page{width:46%}.pagination__next-page{text-align:right}.footer-nav{text-align:center}@media only screen and (max-width:767px){body{font-size:15px;line-height:1.65}.container{width:auto}.post,.post-list{padding-top:10px}.post-list-item{display:block}.hljs{border-radius:0;margin-left:-20px;margin-right:-20px;padding:1.4em 20px}li .hljs{margin-left:0}.img-wrapper{margin-left:-20px;margin-right:-20px}}@font-face{font-display:swap;font-family:DM Mono;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthSQBK6PYK3EXw.woff2) format("woff2");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:DM Mono;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYthqQBK6PYK0.woff2) format("woff2");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:Libre Baskerville;font-style:italic;font-weight:400;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWx8QDO-WyrubOA.woff2) format("woff2");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Libre Baskerville;font-style:italic;font-weight:400;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKhZrc3Hgbbcjq75U4uslyuy4kn0qNcWxEQDO-Wyrs.woff2) format("woff2");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:Libre Baskerville;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNXaxMaC82U-ro.woff2) format("woff2");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Libre Baskerville;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/librebaskerville/v14/kmKnZrc3Hgbbcjq75U4uslyuy4kn0qNZaxMaC82U.woff2) format("woff2");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:Libre Franklin;font-style:normal;font-weight:700;src:url(https://fonts.gstatic.com/s/librefranklin/v13/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkD9DPTedX18mETQw.woff) format("woff");unicode-range:u+0102-0103,u+0110-0111,u+0128-0129,u+0168-0169,u+01a0-01a1,u+01af-01b0,u+1ea0-1ef9,u+20ab}@font-face{font-display:swap;font-family:Libre Franklin;font-style:normal;font-weight:700;src:url(https://fonts.gstatic.com/s/librefranklin/v13/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkDtDPTedX18mETQw.woff) format("woff");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Libre Franklin;font-style:normal;font-weight:700;src:url(https://fonts.gstatic.com/s/librefranklin/v13/jizOREVItHgc8qDIbSTKq4XkRg8T88bjFuXOnduhycKkANDPTedX18mE.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}</style><meta name="description" content="A personal website of Shuhei Kagawa. I write mostly on web technologies and life."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@shuheikagawa"><meta property="og:title" content="Shuhei Kagawa"><meta property="og:site_name" content="Shuhei Kagawa"><meta property="og:description" content="A personal website of Shuhei Kagawa. I write mostly on web technologies and life."></head><body><div class="container"><header class="header"><h1 class="header__title"><a href="/">Shuhei Kagawa</a></h1><nav class="header__nav"><ul class="menu"><li class="menu__item"><a href="/about/">About</a></li><li class="menu__item"><a href="/blog/archives/">All posts</a></li></ul></nav></header><div class="main"><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2022/06/03/toy-browser/">Building a toy browser</a></h1><div class="meta"><span class="date">Jun 3, 2022</span> - <a href="/blog/tags/Browser">Browser</a>, <a href="/blog/tags/CSS">CSS</a>, <a href="/blog/tags/Python">Python</a></div></div><div class="content"><div><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/Y_8TV1J_G2-700.avif 700w, /cached/Y_8TV1J_G2-900.avif 900w, /cached/Y_8TV1J_G2-1100.avif 1100w, /cached/Y_8TV1J_G2-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/Y_8TV1J_G2-700.webp 700w, /cached/Y_8TV1J_G2-900.webp 900w, /cached/Y_8TV1J_G2-1100.webp 1100w, /cached/Y_8TV1J_G2-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/Y_8TV1J_G2-700.png 700w, /cached/Y_8TV1J_G2-900.png 900w, /cached/Y_8TV1J_G2-1100.png 1100w, /cached/Y_8TV1J_G2-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Screenshot of my toy browser showing this website" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FZQUFBRGFtMmRnQUFBQUNYQklXWE1BQUJZbEFBQVdKUUZKVWlUd0FBQUJEa2xFUVZRWWxRRURBZnorQU9IaDRjUGk0dU8wNCtQa3QrRGg0YmZpNHVPMzR1TGp0K0xqNDdYajQrVEEyZG5aU0FEMTlmWC82T2puLytUazQvL2s1T1QvNXVibS8rM3M3UC96OHZMLzlQVDAvK2ZuNW1zQSsvdjcvK0xrNXZqajV1Zjg3dS92L096dDd2ejMrdno4L2Y3LytmajQrUC9zN094bEFQcjYrLy9lenNUN3liS24vcCtabWY2cW9aeisxTHl0L3VmYjFQejYvUDMvNnVub1pnRDYrL3oveHFlVjkyNU5QUHVBYUUzN2YybE8rMzVZUS9yWXY3SDQvUC8vLytQaDRHUUEvdi8vLzdhZGtmOXJUVGIvcnNiQS82T3NtLzlxU0RMLzByNnovLzcvLy8vbTVPTnRBTjdnNEl5aWlYdUNVend2aEh5Umo0UnVmbjJFVnprb2hMbW1tNExoNU9XS3pzM01OQi9PeDUwMHFxS0xBQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')" src="/cached/Y_8TV1J_G2-700.png" width="1400" height="1003"></picture></span></p><p>In the last several weeks, I have been building a toy browser based on an online book, <a href="https://browser.engineering">Web Browser Engineering</a>. As someone who spent a fair share of his career on web frontend, it was eye-opening and satisfying. It felt like I had been living on one side of a wall for years and finally visited the other side of the wall. I imagine other web frontend folks would like it as well.</p><h2>The book</h2><p><a href="https://browser.engineering/">Web Browser Engineering</a> is an online book by Pavel Panchekha and Chris Harrelson. It explains how browsers work and lets you implement a toy browser almost from scratch. HTTP, CSS parser, HTML parser, rendering pipeline (style, layout, paint), the interaction between browser window and tabs, JavaScript, animation, and the list goes on. It uses only a handful of libraries such as TCP, Tkinter (replaced by Skia and SDL in later chapters), and dukpy.</p><p>I discovered it on Twitter. Once I started reading the book, I was hooked. It presents succinct code to implement browser features incrementally. You are always with working code.</p><p>Each topic lays a good foundation that you can build upon and links to relevant resources. Exercises let you implement features on your own.</p><p>Even before the book, I had read a good amount of articles about how browsers work <em>from outside</em>. The book explained concepts in a way that readers could implement them. I learned a lot.</p><h2>Beyond the book</h2><p>I wanted to render real-world websites. Well, real-world websites on the simpler side. Not JavaScript-driven applications. HTML, CSS, and a bit of JavaScript. This website and the book's website were my main targets. Wikipedia was a stretch goal.</p><p>The goal has been partially achieved.</p><iframe style="width: 100%; aspect-ratio: 1280 / 880;" src="https://www.youtube-nocookie.com/embed/xlWsv1C6VOA?mute=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><p>Even for rendering simple websites, I had to implement or revamp numerous browser features beyond the book.</p><h3>HTML</h3><p>I revamped the recursive descent HTML parser from the book to support quoted attributes, raw text elements, etc. Among HTML, CSS, and JavaScript (ECMAScript), the HTML spec was the easiest to read and implement (partially).</p><p>Fun facts:</p><ul><li><a href="https://html.spec.whatwg.org/multipage/parsing.html#determining-the-character-encoding">Browsers are supposed to <em>sniff</em> the character encoding of a web page</a>.</li><li><a href="https://html.spec.whatwg.org/multipage/syntax.html#optional-tags">HTML spec has quite detailed rules for tag omission</a>.</li><li><a href="https://html.spec.whatwg.org/multipage/parsing.html#an-introduction-to-error-handling-and-strange-cases-in-the-parser">HTML spec explains how to handle invalid markups</a> like <code>&lt;b&gt;&lt;i&gt;&lt;/b&gt;&lt;/i&gt;</code>. HTML parser never fails!</li></ul><h3>CSS and rendering</h3><p>I was drawn to implementing CSS features. CSS is more forgiving than JavaScript—at least for a toy browser. Even if my toy browser missed most of the CSS features, it still rendered something on the screen. On the other hand, JavaScript halts execution on a single missing syntax or feature. I would need to implement a bunch of browser APIs until the toy browser could run real-world scripts. So, I focused on CSS and rendering for the toy browser.</p><p>While I was working on the project, my best friends were <a href="https://developer.mozilla.org">MDN</a> and CSS specs (<a href="https://www.w3.org/TR/CSS22/">CSS 2</a> and <a href="https://www.w3.org/Style/CSS/specs.en.html" title="All CSS specifications">more</a>). Yes, there are quite readable.</p><p>One surprise for me was that CSS syntax doesn’t say much about property values. Each property has own syntax. For example, <code>font-family</code> and <code>animation</code> have different precedence rules for commas and spaces.</p><p><code>font-family</code> puts commas higher precedence than spaces:</p><pre><code class="hljs css"><span class="hljs-comment">/* (1.6em) (bold) (Helvetica, Arial, sans-serif) */</span>
<span class="hljs-attribute">font-family</span>: <span class="hljs-number">1.6em</span> bold Helvetica, Arial, sans-serif;
</code></pre><p><code>animation</code> does the other way around:</p><pre><code class="hljs css"><span class="hljs-comment">/* (slidein 3s), (move 10s) */</span>
<span class="hljs-attribute">animation</span>: slidein <span class="hljs-number">3s</span>, move <span class="hljs-number">10s</span>;
</code></pre><p>The book skipped whitespace handling but it was necessary for nice-looking code blocks (<code>white-space: pre</code>). The CSS spec has <a href="https://www.w3.org/TR/css-text-3/#white-space-rules">elaborate rules for ignoring and collapsing whitespace</a>. I made up a greedy algorithm instead of implementing the full spec. It's not 100% accurate, but it looks alright.</p><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/K4c4VxcKAV-700.avif 700w, /cached/K4c4VxcKAV-900.avif 900w, /cached/K4c4VxcKAV-1100.avif 1100w, /cached/K4c4VxcKAV-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/K4c4VxcKAV-700.webp 700w, /cached/K4c4VxcKAV-900.webp 900w, /cached/K4c4VxcKAV-1100.webp 1100w, /cached/K4c4VxcKAV-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/K4c4VxcKAV-700.png 700w, /cached/K4c4VxcKAV-900.png 900w, /cached/K4c4VxcKAV-1100.png 1100w, /cached/K4c4VxcKAV-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Screenshot of the toy browser showing a page with code blocks" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FZQUFBRGFtMmRnQUFBQUNYQklXWE1BQUJZbEFBQVdKUUZKVWlUd0FBQUF5a2xFUVZRWWxUMk9UV3JFTUF5RmZhZ2VvZ2RwdXltOXhEQ3JvY2RweWJiUTdISUNFOElFYTlLeDgyT1RpR0E3RGxaUm9GMTh2TWREMHBPNHR0ZHZwZUJEYTEzY2JsM1JkVC9GL1g3NFR3RDRrbEkrQ21NTWFhM0pPVWZXMm4vMTNsT01rWVpoZUJVY0tvQUFBRHVqdGQ3N3Z0K0pLQklSTHp5TGVaN0pHSlBHY2N6TU5FM1pXc3U2SXlJdHkvSWlOcitSczg2SEVGTE8rWThORVFOWEl1S1RpQ0h5OU5IUHBKUzQ1ZmlOTDYzcitpYnF1bjZYVXA2VVV1ZTJiUS9ZbDJWNXFxcnEwalROd3krUjF1SmsvemQydHdBQUFBQkpSVTVFcmtKZ2dnPT0iPgogICAgPC9pbWFnZT4KICA8L3N2Zz4=')" src="/cached/K4c4VxcKAV-700.png" width="1400" height="1003"></picture></span></p><p>Web fonts were essential to make my toy browser look nice. I revamped the CSS parser to support the <code>@font-face</code> rule and implemented rudimentary font synthesis and font matching. Skia took care of the actual rendering.</p><p>I also learned a few things about the inline layout (or normal flow). The box model is considered to be a basic for frontend developers. But did you know how the inline layout works? What's the difference between <code>line-height: 1</code> and <code>line-height: 1em</code>? Why doesn't vertical-align help vertical centering? <a href="https://iamvdo.me/en/blog/css-font-metrics-line-height-and-vertical-align">Deep dive CSS: font metrics, line-height and vertical-align</a> by Vincent De Oliveira is an amazing article that explains those things.</p><p>Fun facts:</p><ul><li><a href="https://www.youtube.com/watch?v=Y5Xa4H2wtVA" title="BlinkOn 8: Block Layout Deep Dive">Margin collapsing and float are hilariously complex</a>. I implemented only a tip of them.</li><li><a href="https://www.w3.org/TR/css-fonts-4/#font-style-matching">CSS Fonts Module</a> has line charts to explain the font matching algorithm. Browsers try their best to pick fonts for you without you even noticing it.</li><li><a href="https://www.w3.org/TR/css-lists-3/">The list counter spec</a> is quite advanced. You can create counters, increment them and use them as part of <code>content</code> in CSS.</li></ul><h3>Other stuff</h3><p>I also implemented other stuff.</p><ul><li>Retina display to make the toy browser look good on my laptop</li><li>Window resizing: SDL doesn’t seem to provide a good API for resizing</li><li>URL parsing: Parsing URLs into objects made it easier to implement many other parts of the project. I should have done it earlier.</li><li>Content Security Policy: The CSP implementation from the book blocks legitimate requests. I implemented the bare minimum to allow legitimate resource loading.</li></ul><h2>Python</h2><p>The book uses Python for <a href="https://browser.engineering/blog/why-python.html" title="Why Python? | Web Browser Engineering">good reasons</a>. I followed the path and used Python because I wanted to focus on the subject instead of spending time on <em>how to do X in Y language</em>. I had already made enough (fun) mistakes of this kind in my life.</p><p>Also, it was a good opportunity for me to learn Python. Python is used in a lot of places now, but I had survived without learning it before the project. After writing thousands of lines, I like its concise syntax.</p><p>I used <a href="https://github.com/microsoft/pyright">pyright</a> for static type-checking along with <a href="https://github.com/fannheyward/coc-pyright">coc-pyright</a> on Vim. Its type inference worked quite well for me. It uses a gradual typing approach similar to TypeScript although Python’s type annotation is part of the language specification. Python’s typing features don’t look as powerful as TypeScript, but they met more than 90% of my needs. Also, auto-completion was helpful for a Python beginner.</p><p>My toy browser uses only a handful of third-party libraries. They either had type annotations or had only small little surface in my toy browser. The only exception was <a href="https://github.com/kyamagu/skia-python">skia-python</a>. I used it a lot. It didn’t have official type stubs, so <a href="https://github.com/kyamagu/skia-python/issues/133#issuecomment-1066141203">I generated them with mypy's stubgen</a>. The generated stubs were not perfect but good enough as a foundation to build upon for my limited use case.</p><p>I used <a href="https://github.com/psf/black">black</a> for code formatting and <a href="https://github.com/pytest-dev/pytest/">pytest</a> for unit testing. I don't have much to say about them because they <em>just worked™</em>.</p><h2>Conclusion</h2><p>It’s been a fun side project with lots of learning. I imagine other web frontend folks would like it as well. I recommend you check out <a href="https://browser.engineering" title="Web Browser Engineering">the book</a> and build your own toy browser!</p></div></div></div><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2021/12/31/2021-in-review/">2021 in review</a></h1><div class="meta"><span class="date">Dec 31, 2021</span> - <a href="/blog/tags/Review">Review</a></div></div><div class="content"><div><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/EFLvHf52dT-700.avif 700w, /cached/EFLvHf52dT-900.avif 900w, /cached/EFLvHf52dT-1100.avif 1100w, /cached/EFLvHf52dT-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/EFLvHf52dT-700.webp 700w, /cached/EFLvHf52dT-900.webp 900w, /cached/EFLvHf52dT-1100.webp 1100w, /cached/EFLvHf52dT-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/jpeg" srcset="/cached/EFLvHf52dT-700.jpeg 700w, /cached/EFLvHf52dT-900.jpeg 900w, /cached/EFLvHf52dT-1100.jpeg 1100w, /cached/EFLvHf52dT-1400.jpeg 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="A view from a lift in Amden" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FJQUFBQlYrZkEzQUFBQUNYQklXWE1BQUFzVEFBQUxFd0VBbXB3WUFBQUF6MGxFUVZRSW1RSEVBRHYvQUYxcmhYK1J0WTJneEphcHlKV295SlNtd3FHMjBhZTkyYTNENFFCMmYzeDRnb09BalpTUG5xMldwTFdFa0tHd3Y5YkMwdXJIMk8wQVkycFFZR1pRZG5obVpXaGNkSGxmY1hoamlaQjNqcGFGaEl1Q0FJdVJTWHVDUkY5alRZNlBWb3VQUm9lSlM1T1ZSNVdYUkYxZU5nQndkVXlEaEZ4OGdGR0VpMHR1ZFQxc2NqeU1ra3Q4ZmtjME9CMEFZV1U1Yld4RmZudFppb0pxVEVrM1NVa21oWHhwUVQwOUFnUUVBSVNHUTMrQ1FXVnFORGxBS1I0aUdDa25HU3dxSHdzTENRZ0lCeVI2VThPbHFpdXRBQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')" src="/cached/EFLvHf52dT-700.jpeg" width="1400" height="1050"></picture></span></p><p>I turned 40 this year. I've lived roughly half of my life—in a happy case. If time gets faster as we age, it'd be more than half. But 2021 didn't feel short to me, probably thanks to a lot of changes this year.</p><h2>Move</h2><p>My biggest event this year was the move to Switzerland. In December 2020, I started working remotely from Berlin for a team in Zürich. Then I flew into Zürich at the end of March and moved into my current apartment in June.</p><p>International moves are not easy, but everything felt three times harder during the pandemic. We terminated numerous contracts by letter/phone/email, packed books and furniture, gave away the rest, emptied the apartment in Berlin, and departed from the new BER airport. I didn't say goodbye in person to most of my friends in Berlin. We checked into a temporary apartment, found a long-term apartment, bought furniture piece by piece. We finally felt we settled down in the autumn.</p><h2>Zürich</h2><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/2FBedJuQfK-700.avif 700w, /cached/2FBedJuQfK-900.avif 900w, /cached/2FBedJuQfK-1100.avif 1100w, /cached/2FBedJuQfK-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/2FBedJuQfK-700.webp 700w, /cached/2FBedJuQfK-900.webp 900w, /cached/2FBedJuQfK-1100.webp 1100w, /cached/2FBedJuQfK-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/jpeg" srcset="/cached/2FBedJuQfK-700.jpeg 700w, /cached/2FBedJuQfK-900.jpeg 900w, /cached/2FBedJuQfK-1100.jpeg 1100w, /cached/2FBedJuQfK-1400.jpeg 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Sun and alps over the Limmat river and the Zürich lake" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FJQUFBQlYrZkEzQUFBQUNYQklXWE1BQUFzVEFBQUxFd0VBbXB3WUFBQUF6MGxFUVZRSW1RSEVBRHYvQUdHR3VtV0p2V3VQdzVhdzVKQ3MzbXlQeFdhS3ZtR0Z1VnA5c0FCamg3cHhtdE5zbHRDZ3Z1V2F1ZU54bTlaMG05SnZsczFxa2NzQVBFdGpkSmJHaWEvZ2k3UGxqTFRtaTdQbWg2L2tmS1BYWW9DcUFCMGFIVXRQV25hQmxaeXJ4SmVxeUhPSG8yRnZpRXRTWVVCQVJBQWxLVEZUWjRWcGhheDRrcmg0bHI1cWliTlliWTVOV25GRlNFOEFJU2sxVG1xUFdIcWtmSlMwYkllc1ZuYWVYWHVpVjNLWVAxRnZBQ28xU1RWSVpUUkthWU9MbjF0c2hURklhRFZJWkRaSFlqZElZK29DWGlmU0ZGZDBBQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')" src="/cached/2FBedJuQfK-700.jpeg" width="1400" height="1050"></picture></span></p><p>Zürich is small. Almost everything is within walking distance. It doesn't have as many trees and parks as Berlin does, but the Zürich lake and mountains are nearby. You can see snow-crowned alps across the lake. My biggest complaint is that most of the streets and sidewalks are covered with asphalt. They are good when you carry suitcases, but I don't like how they look.</p><p>People here seem to be early birds. Streets become noisy around 7 a.m., so I had to adjust myself to become an early bird. I go for a walk after 9 a.m., and parks and coffee shops are almost empty where I'd see more people in Berlin. On the other hand, cafes and bars get full of people enjoying <em>apéro</em> in the late afternoon, especially in summer.</p><p>It's expensive to eat out here—twice or more of Berlin. I haven't tried many because of the pandemic and the price. On the other hand, more Japanese groceries are available here. Also, I'm happy that supermarket chains sell sashimi-quality salmon and tuna. Especially, Migros' salmon is amazing.</p><h2>Language</h2><p>Even though Zürich is a German-speaking city, many people speak fluent English. It feels much easier to live here without speaking German than in Berlin. But this situation of no pressure somehow motivated me. I started learning German again with Duolingo.</p><p>I learned some Swiss-German phrases like <em>merci vielmal</em> meaning <em>thank you very much</em>. Such a nice expression of multilingualism. Also, I learned that the <em>-li</em> suffix was Swiss German. The most famous one would be muesli (<em>Müsli</em>), and some of you may know the compression algorithm Brotli (<em>Brötli</em>).</p><h2>Travels</h2><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/UbTlckszgB-700.avif 700w, /cached/UbTlckszgB-900.avif 900w, /cached/UbTlckszgB-1100.avif 1100w, /cached/UbTlckszgB-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/UbTlckszgB-700.webp 700w, /cached/UbTlckszgB-900.webp 900w, /cached/UbTlckszgB-1100.webp 1100w, /cached/UbTlckszgB-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/jpeg" srcset="/cached/UbTlckszgB-700.jpeg 700w, /cached/UbTlckszgB-900.jpeg 900w, /cached/UbTlckszgB-1100.jpeg 1100w, /cached/UbTlckszgB-1400.jpeg 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Matterhorn and its reflection on a lake" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FJQUFBQlYrZkEzQUFBQUNYQklXWE1BQUFzVEFBQUxFd0VBbXB3WUFBQUF6MGxFUVZRSW1RSEVBRHYvQUhDZzhYT2U1VytaM1dTUTFWbUd6RkY3d1VsenQwaHdzMGR1c0FCUmNhVnZvdkp2b3ZGc25lcHFtdVZoanRoWmh0RmJpTkpZaGRBQUh5VXRPMDl1Ylp6ZmE1YlhiNTNpZnJML2dLMzJlS1h1ZEp2ZUFFWk1XRFk1UVRJN1IxZGhjMWhtZjJsL29WOXprMmg0azJGbGNRQkJSRUJJUzBrL1ZHOU5ZWHRRWjRkY2ZhdGdlcUJ6ZkladGJtZ0FKREF1UEZOc1RHNlpSV0dHUldHRlNHU0lTV1NIWW05NlpXbG1BRHRNWHp4T1pUcEpXVDFMVnp4SVVUZEVUVGREU3pkRVRUcEhUN2hsVlVtNkNRR25BQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')" src="/cached/UbTlckszgB-700.jpeg" width="1400" height="1050"></picture></span></p><p>I got a new hobby, hiking. Well, I had to, because it's Switzerland. Starting from Uetliberg—Zürich's <a href="https://en.wikipedia.org/wiki/Hausberg"><em>Hausberg</em></a>—I hiked on Rigi, Pfannelstiel, Lägern, Pilatus, Zermatt, Amden, and Sihlwald.</p><p>The Swiss government provides an impressive map website/app called <a href="https://www.schweizmobil.ch/en/hiking-in-switzerland.html">SwitzerlandMobility</a>. It shows everything necessary for hiking and allows you to plan your next trip.</p><p>In addition to mountains, I visited several Swiss cities: Luzern, Rapperswil, Basel, Bern, Lugano, and Neuchâtel. They were all small and walkable. Before my move, I didn't know that there were many medieval towns in Switzerland. It was fun to walk through Switzerland, Germany, France, and Switzerland again in Basel.</p><p>I was able to travel a lot because Swiss transportation is great and the land is small. In terms of area, Switzerland is only 40% bigger than Brandenburg and half of Hokkaido.</p><h2>Food and drinks</h2><p>I've been exploring the famous Swiss Cheese. Emmentaler, Appenzeller, Gruyere, Vacherin, and so on. I learned that Parmigiano Reggiano was not necessarily the best cheese in the world.</p><p>Also, I almost stopped drinking alcohol, including beer. Instead, I've been practicing latte art and drinking coffee every day.</p><h2>Social media</h2><p>I'm trying to reduce my usage of social media. Sometime this year, I realized that I was spending more than 3 hours every day on Twitter. That was horrific. In addition, social media timelines show less and less content from my actual friends. They show recommendations and content that my friends <em>liked</em>. I tried to limit time first, but it didn't work. So, I just stopped using them altogether for a few months. It felt great. I got more time to read books and became attentive to what was going on around me.</p><h2>Books</h2><p>I bought roughly 60 books, <a href="https://www.goodreads.com/user/year_in_books/2021/57764964">read 12 of them</a>, and half-read several more. I couldn't read much around the move but started picking up in the winter. I especially liked that <em>Tyranny of Merit</em> and <em>Four Thousand Weeks</em> made me step back and think about how to spend the rest of my life.</p><h2>Work</h2><p>It's been a year since I started my current job. It took me the whole year to feel comfortable with it. My managers told me I was doing fine, but I didn't feel I was catching up fast enough. The tech stack was completely new to me. It was hard to focus on work for the few months around the move. Imposter syndrome was real. Working from home didn't help here.</p><p>Fortunately, it gradually improved. I was able to focus again after settling down in my current apartment. I slowly felt belonged when I commuted to the office and met teammates in person. My starter project turned out to be more complex than I expected, but I'm happy that I finished it. I started getting some other responsibilities. There's still a long way to go, but now I feel I can do <em>something</em>.</p><h2>Conclusions</h2><p>In 2021, I moved to a new country, settled down at home and work, traveled a lot, and had some chance to step back and reflect. I'm looking forward to what's to come in 2022!</p><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/6Mm0Vpe0fg-700.avif 700w, /cached/6Mm0Vpe0fg-900.avif 900w, /cached/6Mm0Vpe0fg-1100.avif 1100w, /cached/6Mm0Vpe0fg-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/6Mm0Vpe0fg-700.webp 700w, /cached/6Mm0Vpe0fg-900.webp 900w, /cached/6Mm0Vpe0fg-1100.webp 1100w, /cached/6Mm0Vpe0fg-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/jpeg" srcset="/cached/6Mm0Vpe0fg-700.jpeg 700w, /cached/6Mm0Vpe0fg-900.jpeg 900w, /cached/6Mm0Vpe0fg-1100.jpeg 1100w, /cached/6Mm0Vpe0fg-1400.jpeg 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Cow on a field" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCA5IDciPgogICAgPGZpbHRlciBpZD0iYiIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj4KICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iLjUiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgIDxmZUNvbXBvbmVudFRyYW5zZmVyPgogICAgICAgIDxmZUZ1bmNBIHR5cGU9ImRpc2NyZXRlIiB0YWJsZVZhbHVlcz0iMSAxIj48L2ZlRnVuY0E+CiAgICAgIDwvZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgIDwvZmlsdGVyPgogICAgPGltYWdlIGZpbHRlcj0idXJsKCNiKSIgeD0iMCIgeT0iMCIKICAgICAgaGVpZ2h0PSIxMDAlIiB3aWR0aD0iMTAwJSIKICAgICAgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBa0FBQUFIQ0FJQUFBQlYrZkEzQUFBQUNYQklXWE1BQUFzVEFBQUxFd0VBbXB3WUFBQUF6MGxFUVZRSW1RSEVBRHYvQUZxRHUxVjl0Vko2c1U1M3IwMTJyMHQwcjBwenJVbHZwa1ZwblFCcGxkSm1rYzFpak1sZWljWmFoc1JaaGNSWWhNSlpnOEpWZnJrQWVLYmlkYVBnY3FEZ2NKL2hjS0RsY0tEbmI1L25acFRYWkk3T0FLakw5NkxFNzVtNjQ0K3YxWHljdTNpWHNIU1RyVTFlWDBWVFV3QnRoSDVtZVdoY2JrOVJZanBQWHpOTVdUNUtXQzlOWGk5TVh6a0FTbGtsU0ZZalIxY2xTVm9vUzEwdFMxd3pTbHd2VFdFelMyQTRBRWhWS1VSU0tFZFhLVUJPSno1TUowTlNKMFpYTFVwZk5VbGJMMGVOVk8vRlZGWTlBQUFBQUVsRlRrU3VRbUNDIj4KICAgIDwvaW1hZ2U+CiAgPC9zdmc+')" src="/cached/6Mm0Vpe0fg-700.jpeg" width="1400" height="1050"></picture></span></p></div></div></div><div class="post"><div class="post-header"><h1 class="title"><a href="/blog/2021/02/23/new-look/">New look</a></h1><div class="meta"><span class="date">Feb 23, 2021</span> - <a href="/blog/tags/Blog">Blog</a></div></div><div class="content"><div><p>I updated this website’s design and replaced its static site generator with Eleventy. Here are some notes about the new look and implementation details.</p><h2>Design</h2><p>I had used only sans-serif fonts on this website. Serif fonts felt too fancy. But I like serif fonts on paper books. Many of them use serif fonts regardless of the fanciness of their contents. I wanted to do so for my website as well. But I didn’t know which font to use. There are so many fonts in this world, and Google Fonts has tons of serif fonts. So, I used <a href="https://www.typewolf.com/blog/google-fonts-combinations">a type pairing from Typewolf</a>—Libre Franklin for headings and Libre Baskerville for body text.</p><p>For code blocks, I chose DM Mono. DM Mono is a monospace font commissioned by Deep Mind—yes, they have their own fonts. Its “f” has a fancy touch. I use it for coding these days after years with Fira Code.</p><pre><code class="hljs sh"><span class="hljs-keyword">function</span> greet(name) {
  <span class="hljs-built_in">return</span> `Hello, <span class="hljs-variable">${name}</span>!`;
}
</code></pre><p>This website has mostly text and a few images. Web fonts are the only luxury that I put.</p><h2>Tech</h2><p>I replaced my home-grown static site generator using gulp with Eleventy. I liked gulp—it was a good use case of Node.js streams. But I wanted to try something new. I picked Eleventy simply because I heard its name many times and it runs on Node.js, which has a large ecosystem of web tooling.</p><p>Also, I removed Disqus and Google Analytics. This website is almost free of cookies now. The last one standing is Cloudflare’s bot detection cookie, which <a href="https://blog.cloudflare.com/deprecating-cfduid-cookie/">will be removed in May 2021</a>.</p><h2>Implementation details</h2><p>I took image optimization techniques from <a href="https://github.com/google/eleventy-high-performance-blog">google/elventy-high-performance-blog</a>—next-gen image formats (AVIF and WebP), multiple image sizes (<code>srcset</code>), blurred placeholders with SVG, immutable image URLs, aspect ratio by setting <code>width</code> and <code>height</code>, lazy loading and async decoding. The implementation is rather wild. It parses each full HTML with <code>jsdom</code>, finds <code>&lt;img&gt;</code> tags, read and optimize linked image files, and replaces the <code>&lt;img&gt;</code> tags with optimized <code>&lt;picture&gt;</code> elements.</p><p>I implemented a funny feature that inserts <code>&lt;wbr&gt;</code> into longCamelCase words—like <code>long&lt;wbr&gt;Camel&lt;wbr&gt;Case</code>—to break them on small screens. Some posts on this website have long titles such as “Check your server.keepAliveTimeout.” Those titles overflow on small screens. I could use a smaller font size for the titles, but I wanted to use a big font. <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/wbr"><code>&lt;wbr&gt;</code></a> HTML tag tells browsers that they can break lines there if necessary. I created <a href="https://github.com/shuhei/shuhei.github.com/blob/32d95d80b741cad9cb3f49a990bc598f52e427fd/lib/filters/wbr.js">a template filter to insert it</a>.</p><p><span class="img-wrapper"><picture><source type="image/avif" srcset="/cached/jhwwfjyH5O-700.avif 700w, /cached/jhwwfjyH5O-900.avif 900w, /cached/jhwwfjyH5O-1100.avif 1100w, /cached/jhwwfjyH5O-1400.avif 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/webp" srcset="/cached/jhwwfjyH5O-700.webp 700w, /cached/jhwwfjyH5O-900.webp 900w, /cached/jhwwfjyH5O-1100.webp 1100w, /cached/jhwwfjyH5O-1400.webp 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><source type="image/png" srcset="/cached/jhwwfjyH5O-700.png 700w, /cached/jhwwfjyH5O-900.png 900w, /cached/jhwwfjyH5O-1100.png 1100w, /cached/jhwwfjyH5O-1400.png 1400w" sizes="(max-width: 767px) calc(100vw - 40px), 700px"><img alt="Heading with  on the left and heading without it on the right" loading="lazy" decoding="async" style="background-size: cover; background-image: url('data:image/png;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgIHZpZXdCb3g9IjAgMCAxMiA1Ij4KICAgIDxmaWx0ZXIgaWQ9ImIiIGNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycz0ic1JHQiI+CiAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249Ii41Ij48L2ZlR2F1c3NpYW5CbHVyPgogICAgICA8ZmVDb21wb25lbnRUcmFuc2Zlcj4KICAgICAgICA8ZmVGdW5jQSB0eXBlPSJkaXNjcmV0ZSIgdGFibGVWYWx1ZXM9IjEgMSI+PC9mZUZ1bmNBPgogICAgICA8L2ZlQ29tcG9uZW50VHJhbnNmZXI+CiAgICA8L2ZpbHRlcj4KICAgIDxpbWFnZSBmaWx0ZXI9InVybCgjYikiIHg9IjAiIHk9IjAiCiAgICAgIGhlaWdodD0iMTAwJSIgd2lkdGg9IjEwMCUiCiAgICAgIHhsaW5rOmhyZWY9ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQXdBQUFBRkNBWUFBQUJ4ZWcwdkFBQUFDWEJJV1hNQUFCWWxBQUFXSlFGSlVpVHdBQUFBdDBsRVFWUUltVDJPeTQ1RVFBQkYvZi9uMEdzTG9WcEprR0NvN3NSRzBzVmtqQ1lJRm5JNktwUFozVWZ1eWJXR1lhRHZlL1o5WjlzMkxqOU5FK000R24wY2grbXViSjVuckN6TDhEeVBPSTRKd3hDdE5lZDVrcVlwcnVzaVpZZ1FncnF1emNpU1V1STROcmViZzIwN1JGRmtxRXBWQklGQWlEdSs3LzlEcmJJc0NlNlMvS3VpeUhPU0pERlhodUVYM1g3ejA3OTUvOTFlMXhYckVxK1hScmNkWGRmUnRpM0xzdEEwRFVWUjhIdytxQ3FGVXNxQVBtVDExM2c1cHJwdUFBQUFBRWxGVGtTdVFtQ0MiPgogICAgPC9pbWFnZT4KICA8L3N2Zz4=')" src="/cached/jhwwfjyH5O-700.png" width="1400" height="595"></picture></span></p><p>This website has <a href="/blog/2019/10/13/generating-twitter-card-images/">a feature to generate Open Graph images—or Twitter Card images—using <code>node-canvas</code> for blog posts without any images</a>. <s>I used Eleventy’s pagination with <code>size: 1</code> to implement it. It’s a cool way to generate another file for each post in a collection.</s> <em>Edit on Jan 2, 2022:</em> <a href="https://github.com/shuhei/shuhei.github.com/commit/42a61c030397eca9bf66f2faf4f1ad6c2c83dd8c">I replaced the pagination method with computed data that generates Open Graph images on demand in memory.</a></p><p>Another trick worth mentioning is <a href="https://github.com/shuhei/shuhei.github.com/blob/32d95d80b741cad9cb3f49a990bc598f52e427fd/source/_data/style.js">generating CSS as Eleventy’s global data</a>. Based on a regular CSS file, I wanted to inline Google Fonts CSS at build time (and preload woff2 files in it), apply <code>postcss</code> to it for transformation and optimization, and embed it into each HTML file. <a href="https://www.11ty.dev/docs/quicktips/inline-css/">The quick tip to inline minified CSS on Eleventy documentation</a> was not ideal for my use case. It didn’t feel like a valid use case of a <code>filter</code> to asynchronously fetch remote data, and it took a few extra seconds to run the same CSS optimization for every HTML file. <a href="https://www.11ty.dev/docs/data-global/#using-javascript-instead-of-json">Global data with JavaScript</a> runs only once regardless of the number of templates that use it, and we can do almost anything.</p><h2>Thoughts on Eleventy</h2><p>I had a good experience with Eleventy. It was easy to start with, and its hot reload worked out of the box. Its data cascade is powerful. But it took some time for me to understand the powerful data (and content) cascade. To implement features inherited from the previous version, I had to read most of the documentation in the end.</p><p>It’s not the best tool for someone who just wants to write blog posts out of the box. You’ll need to write some JavaScript. But if you want to have fun writing JavaScript to implement whatever feature you like, it’s a great option.</p></div></div></div><ul class="pagination"><li class="pagination__prev-page"></li><li class="pagination__next-page"><a href="/blog/pages/2/">Older posts</a></li></ul><nav class="footer-nav"><a href="/blog/archives/">All posts</a></nav></div><footer class="footer">© Shuhei Kagawa</footer></div></body></html>