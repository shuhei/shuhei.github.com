<!doctype html><html><head><title>Radiation Map</title><meta charset="utf-8"><link rel="stylesheet" href="css/custom-theme/jquery-ui-1.8.11.custom.css" type="text/css" media="screen" title="no title" charset="utf-8"><script src="js/jquery-1.5.1.min.js" type="text/javascript"></script><script src="js/jquery-ui-1.8.11.custom.min.js" type="text/javascript"></script><script src="js/protovis-r3.2.js" type="text/javascript"></script><script src="http://maps.google.com/maps?file=api&amp;v=3&amp;sensor=false&amp;key=ABQIAAAAHvsWQgrETJTTeYhE321hXhTP5XpKub0fy6ErsFEre_kMgzjudxQB1oStRPNuajmEH0yIOspiRNMq2A" type="text/javascript"></script><script src="js/radiation.js" type="text/javascript"></script><style type="text/css">body {
        margin: 0;
        font-family: sans-serif;
      }
      #wrapper {
        width: 940px;
        margin: 30px auto;
      }
      #map {
        height: 500px;
      }
      #map .canvas {
        position: absolute;
      }
      #control {
        margin: 20px 0;
      }
      #control #slider {
        font-size: 15px;
        width: 460px;
        display: inline-block;
        margin-right: 20px;
      }
      .detail {
        width: 220px;
        padding: 0px 20px 20px 0;
        float: left;
      }
      .detail.last {
        padding-right: 0;
      }
      h3 {
        font-size: small;
      }
      .clear {
        clear: both;
      }</style><script type="text/javascript+protovis">(function() {
        /**
          @class A customized overlay that shows radiation levels.
         */
        function Canvas(prefectures) {
          //prefectures[6] = prefectures[50];
          //prefectures.splice(47, 7);
          prefectures.splice(6, 1);
          this.prefectures = prefectures;
        }

        Canvas.prototype = pv.extend(GOverlay);

        Canvas.prototype.initialize = function(map) {
          this.map = map;
          this.canvas = document.createElement("div");
          this.canvas.setAttribute("class", "canvas");
          map.getPane(G_MAP_MAP_PANE).parentNode.appendChild(this.canvas);
          this.i = times.length - 1;
        };

        Canvas.prototype.redraw = function(force) {
          if (!force) return;
          var c = this.canvas,
              m = this.map,
              r = 200,
              i = this.i;
          var descPrefectures = this.prefectures.slice(0).sort(function(a, b) b.radiation[i] - a.radiation[i]);
          
          // Get the pixel locations of the cities.
          var pixels = descPrefectures.map(function(d) {
            return m.fromLatLngToDivPixel(new GLatLng(d.lat, d.lon));
          });
          
          var daiichi = m.fromLatLngToDivPixel(new GLatLng(37.4236561847935, 141.040659818406));
          
          // Update the canvas bounds.
          function x(p) p.x;
          function y(p) p.y;
          var x = { min: pv.min(pixels, x) - r, max: pv.max(pixels, x) + r };
          var y = { min: pv.min(pixels, y) - r, max: pv.max(pixels, y) + r };
          c.style.width = (x.max - x.min) + "px";
          c.style.height = (y.max - y.min) + "px";
          c.style.left = x.min + "px";
          c.style.top = y.min + "px";
          
          //var size = pv.Scale.log(0.01, 100.0).range(0, 5 * Math.pow(4, m.getZoom() - 5.0));
          var size = pv.Scale.log(0.01, 10.0).range(0, 45);
          //var color = pv.Scale.log(0.01, 10.0).range("rgba(255, 30, 0, 0.7)", "rgba(255, 100, 0, 0.7)");
          var color = pv.Scale.log(0.01, 10.0).range("rgba(255, 80, 0, 0.7)", "rgba(255, 0, 0, 0.7)");
          
          // Render the visualization.
          this.vis = new pv.Panel()
            .canvas(c)
            .left(-x.min)
            .top(-y.min)
          .add(pv.Dot)
            .data(descPrefectures)
            .left(function() pixels[this.index].x)
            .top(function() pixels[this.index].y)
            .strokeStyle(null)
            .fillStyle(function(d) color(d.radiation[i]))
            .radius(function(d) size(d.radiation[i]))
            .title(function(d) d.prefecture + d.city + ": " + d.radiation[i] + " μSv/h")
          .parent.anchor("center").add(pv.Label)
            .data(descPrefectures)
            .textAlign("center")
            .textStyle("#900")
            .visible(true)
            .text(function(d) d.radiation[i])
            .left(function() pixels[this.index].x + 1)
            .top(function() pixels[this.index].y + 1)
          .parent.anchor("center").add(pv.Label)
            .data(descPrefectures)
            .textAlign("center")
            .textStyle("white")
            .visible(true)
            .text(function(d) d.radiation[i])
            .left(function() pixels[this.index].x)
            .top(function() pixels[this.index].y)
          .root.add(pv.Wedge)
            .left(daiichi.x)
            .top(daiichi.y)
            .data([0, 1, 2, 3])
            .innerRadius(0)
            .outerRadius(20)
            .startAngle(function(d) Math.PI / 4 + d * Math.PI / 2)
            .angle(0)
            .strokeStyle("rgba(0, 0, 0, 0.7)")
            .lineWidth(16)
            .title("福島第一原発")
          .root;
          this.vis.render();
        };
        
        /**
          @class A legend for sizes of dots that indicate radiation levels.
         */
        function MyPane() {
        }
        MyPane.prototype = pv.extend(GControl);
        MyPane.prototype.initialize = function(map) {
          var canvas = document.createElement("div");
          canvas.setAttribute('id', 'legend');
          
          this.map = map;
          this.canvas = canvas;
          
          this.draw();
          map.getContainer().appendChild(canvas);
          
          return canvas;
        };
        
        MyPane.prototype.draw = function() {
          var c = this.canvas;
          
          var size = pv.Scale.log(0.01, 10.0).range(0, 45);
          var color = pv.Scale.log(0.01, 10.0).range("rgba(255, 80, 0, 0.7)", "rgba(255, 0, 0, 0.7)");
          var legend = new pv.Panel()
            .canvas(c)
            .width(100)
            .height(60)
          .add(pv.Wedge)
            .right(50)
            .bottom(0)
            .data([10, 1, 0.1])
            .fillStyle(color)
            .strokeStyle(null)
            .startAngle(Math.PI)
            .angle(Math.PI)
            .innerRadius(0)
            .outerRadius(function(d) size(d))
          .add(pv.Label)
            .bottom(function(d) size(d))
            .textStyle("white")
            .textAlign("center")
            .text(function(d) d)
          .root.render();
        }

        MyPane.prototype.getDefaultPosition = function() {
          return new GControlPosition(G_ANCHOR_BOTTOM_RIGHT, new GSize(20, 15));
        };

        MyPane.prototype.getPanel = function() {
          return this.canvas;
        }
        
        // Set up a map
        G_NORMAL_MAP.getMinimumResolution = function() 5;
        G_NORMAL_MAP.getMaximumResolution = function() 9;

        var map = new GMap2(document.getElementById("map"));
        var canvas = new Canvas(prefectures);
        map.setCenter(new GLatLng(36.70, 138.50), 7);
        map.setUI(map.getDefaultUI());
        map.addOverlay(canvas);
        map.addControl(new MyPane());
        
        
        $(function() {
          // Set up slider
          $("#slider").slider({
            range: "min",
          	value: times.length - 1,
          	min: 0,
          	max: times.length - 1,
          	step: 1,
          	slide: function( event, ui ) {
          		$("#time").text(times[ui.value]);
          		canvas.i = ui.value;
              canvas.redraw(true);
          	}
          });
          $("#time").text(times[$("#slider").slider("value")]);
          
          // Draw line charts
          function boxId(id) 'p' + id;
          function chartId(id) 'p' + id + '-chart';
          var w = 200,
              h = 100;
          
          prefectures.forEach(function(p, index) {
            var min = pv.min(p.radiation),
                max = pv.max(p.radiation),
                sx = pv.Scale.linear(0, times.length).range(0, w),
                sy = pv.Scale.linear(0, p.id <= 47 ? 0.4 : 15.0).range(0, h);
                
            var detail = $('<div />', {id: boxId(p.id), 'class': 'detail'})
              .append($('<h3 />').text(p.prefecture + p.city))
              .append($('<div />', {id: chartId(p.id)}))
              .appendTo('#details');
            if (index % 4 === 3) detail.addClass('last');
            
            new pv.Panel()
              .canvas(chartId(p.id))
              .left(20)
              .bottom(20)
              .top(20)
              .width(w)
              .height(h)
            .add(pv.Rule)
              .data(sy.ticks(4))
              .bottom(sy)
              .strokeStyle("#ccc")
            .anchor("left").add(pv.Label)
              .text(sy.tickFormat)
            .root.add(pv.Line)
              .segmented(true)
              .data(p.radiation)
              .left(function () sx(this.index))
              .bottom(function(d) sy(d))
              .visible(function(d) d)
              .strokeStyle("rgba(255, 51, 0, 1)")
            .root.render();
          });
        });
      })();</script></head><body onunload="GUnload()"><div id="wrapper"><h1>放射線量マップ</h1><div id="control"><div id="slider"></div><span id="time"></span></div><div id="map"></div><p>元データ: <a href="http://www.mext.go.jp/a_menu/saigaijohou/syousai/1303723.htm">文部科学省 都道府県別環境放射能水準調査結果</a>（福島県外）, <a href="http://radiation-fukushima.appspot.com/">http://radiation-fukushima.appspot.com/</a>（福島県内） （なお、単位は全て μSv/h）</p><div id="details"><h2>都道府県ごとの推移</h2></div><div class="clear"></div></div><script type="text/javascript">var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-309586-8']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();</script></body></html>